<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema Vida - Alimento Diário</title>
    
    <!-- Carregar React e ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Carregar Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Carregar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Biblioteca QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Carregar Tone.js para áudio dos Jogos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <!-- Fonte Merriweather & Press Start 2P & Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        .font-serif { font-family: 'Merriweather', serif; }
        .font-handwriting { font-family: 'Courier New', Courier, monospace; }
        .font-arcade { font-family: 'Press Start 2P', cursive; }
        .font-inter { font-family: 'Inter', sans-serif; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        /* Animação das barras de áudio */
        @keyframes sound-bar {
            0% { height: 10%; }
            50% { height: 100%; }
            100% { height: 10%; }
        }
        .sound-bar {
            width: 6px;
            background-color: #FCD34D; /* yellow-300 */
            border-radius: 99px;
            animation: sound-bar 0.8s infinite ease-in-out;
        }
        .sound-bar:nth-child(1) { animation-delay: 0.1s; }
        .sound-bar:nth-child(2) { animation-delay: 0.3s; }
        .sound-bar:nth-child(3) { animation-delay: 0.5s; }
        .sound-bar:nth-child(4) { animation-delay: 0.2s; }
        .sound-bar:nth-child(5) { animation-delay: 0.4s; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c0c0c0; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
        
        /* Cursor de movimento para o canvas */
        canvas.cursor-move { cursor: move; }

        /* --- Estilos do Jogo da Memória (3D Flip) --- */
        .memory-card {
            perspective: 1000px;
            cursor: pointer;
        }
        .memory-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            border-radius: 0.5rem;
        }
        .memory-card.is-flipped .memory-card-inner {
            transform: rotateY(180deg);
        }
        .memory-card-front,
        .memory-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .memory-card-back {
            background-color: #3B82F6; /* blue-500 */
            color: white;
            font-size: 2rem;
            transform: rotateY(0deg);
        }
        .memory-card-front {
            background-color: #E5E7EB; /* gray-200 */
            color: #1F2937;
            font-size: 2.5rem;
            transform: rotateY(180deg);
        }

        /* --- Estilos da Forca --- */
        .hangman-part {
            transition: opacity 0.5s ease-in-out;
            stroke: #374151;
            stroke-width: 4;
            stroke-linecap: round;
        }

        /* --- Estilos Financeiro Mobile --- */
        input, select, button { touch-action: manipulation; }
        .tap-target { min-height: 44px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @media print {
            .no-print { display: none !important; }
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, Component, useMemo, useCallback } = React;

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { this.setState({ error: error }); console.error(error, errorInfo); }
            render() {
                if (this.state.hasError) return <div className="p-8 text-center text-red-800"><h1>Algo correu mal.</h1><button onClick={()=>window.location.reload()} className="mt-4 bg-red-700 text-white px-4 py-2 rounded">Recarregar</button></div>;
                return this.props.children;
            }
        }
        
        // --- HOOK PERSISTÊNCIA ---
        function usePersistentState(key, initialValue) {
            const [state, setState] = useState(() => {
                try { const item = localStorage.getItem(key); return item ? JSON.parse(item) : initialValue; } catch { return initialValue; }
            });
            useEffect(() => { try { localStorage.setItem(key, JSON.stringify(state)); } catch {} }, [key, state]);
            return [state, setState];
        }

        // --- HELPERS GERAIS ---
        function formatarEMV(id, value) { const length = ('00' + value.length).slice(-2); return `${id}${length}${value}`; }
        function simplificarTexto(text) { return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^\w\s]/g, ''); }
        function crc16(data) { let crc = 0xFFFF; for (let i = 0; i < data.length; i++) { crc ^= data.charCodeAt(i) << 8; for (let j = 0; j < 8; j++) { crc = (crc & 0x8000) ? (crc << 1) ^ 0x1021 : crc << 1; } } return ('0000' + (crc & 0xFFFF).toString(16).toUpperCase()).slice(-4); }
        const formatDateKey = (date) => date.toISOString().split('T')[0];
        const formatDateDisplay = (date) => date.toLocaleDateString('pt-PT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

        // --- ÍCONES SVG GERAIS (Sistema Vida) ---
        const icons = {
            'home': <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />,
            'book-open': <><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>,
            'heart': <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>,
            'whatsapp': <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>,
            'dollar-sign': <><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></>,
            'activity': <path d="M22 12h-4l-3 9L9 3l-3 9H2" />,
            'sun': <><circle cx="12" cy="12" r="4" /><path d="M12 2v2" /><path d="M12 20v2" /><path d="m4.93 4.93 1.41 1.41" /><path d="m17.66 17.66 1.41 1.41" /><path d="M2 12h2" /><path d="M20 12h2" /><path d="m6.34 17.66-1.41 1.41" /><path d="m19.07 4.93-1.41 1.41" /></>,
            'edit-3': <><path d="M12 20h9" /><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z" /></>,
            'menu': <><line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" /></>,
            'x': <><path d="M18 6 6 18" /><path d="m6 6 12 12" /></>,
            'chevron-left': <path d="m15 18-6-6 6-6" />,
            'chevron-right': <path d="m9 18 6-6-6-6" />,
            'image': <><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><circle cx="9" cy="9" r="2" /><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" /></>,
            'download': <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></>,
            'sparkles': <><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /><path d="M5 3v4" /><path d="M9 3v4" /><path d="M3 5h4" /><path d="M3 9h4" /></>,
            'user': <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>,
            'gamepad-2': <><line x1="6" x2="10" y1="12" y2="12" /><line x1="8" x2="8" y1="10" y2="14" /><line x1="15" x2="15.01" y1="13" y2="13" /><line x1="18" x2="18.01" y1="11" y2="11" /><rect width="20" height="12" x="2" y="6" rx="2" /></>,
            'radio': <><circle cx="12" cy="12" r="2" /><path d="M16.24 7.76a6 6 0 0 1 0 8.49" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14" /></>,
            'music': <><path d="M9 18V5l12-2v13" /><circle cx="6" cy="18" r="3" /><circle cx="18" cy="16" r="3" /></>,
            'megaphone': <><path d="m3 11 18-5v12L3 14v-3z" /><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6" /></>,
            'refresh-cw': <><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></>,
            'search': <><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></>,
            'printer': <><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect width="12" height="8" x="6" y="14" /></>,
            'volume-2': <><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14" /><path d="M15.54 8.46a5 5 0 0 1 0 7.07" /></>,
            'square': <rect width="18" height="18" x="3" y="3" rx="2" />,
            'plus': <><path d="M5 12h14" /><path d="M12 5v14" /></>,
            'minus': <path d="M5 12h14" />,
            'check-circle': <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></>,
            'external-link': <><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" x2="21" y1="14" y2="3" /></>,
            'qr-code': <><rect width="5" height="5" x="3" y="3" rx="1" /><rect width="5" height="5" x="16" y="3" rx="1" /><rect width="5" height="5" x="3" y="16" rx="1" /><path d="M21 16h-3a2 2 0 0 0-2 2v3" /><path d="M21 21v.01" /><path d="M12 7v3a2 2 0 0 1-2 2H7" /><path d="M3 12h.01" /><path d="M12 3h.01" /><path d="M12 16v.01" /><path d="M16 12h1" /><path d="M21 12v.01" /><path d="M12 21v-1" /></>,
            'arrow-left': <><line x1="19" y1="12" x2="5" y2="12" /><polyline points="12 19 5 12 12 5" /></>,
            'share-2': <><circle cx="18" cy="5" r="3" /><circle cx="6" cy="12" r="3" /><circle cx="18" cy="19" r="3" /><line x1="8.59" x2="15.42" y1="13.51" y2="17.49" /><line x1="15.41" x2="8.59" y1="6.51" y2="10.49" /></>,
            'link': <><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></>,
            'calendar': <><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></>,
            'clock': <circle cx="12" cy="12" r="10" />,
            'grid': <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />,
            'anchor': <><circle cx="12" cy="5" r="3" /><line x1="12" y1="22" x2="12" y2="8" /><path d="M5 12H2a10 10 0 0 0 20 0h-3" /></>,
            'play': <polygon points="5 3 19 12 5 21 5 3" />,
            'pause': <><rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" /></>,
            'trash-2': <><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></>,
            'trending-up': <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></>,
            'trending-down': <><polyline points="23 18 13.5 8.5 8.5 13.5 1 6" /><polyline points="17 18 23 18 23 12" /></>,
            'credit-card': <><rect x="1" y="4" width="22" height="16" rx="2" ry="2" /><line x1="1" y1="10" x2="23" y2="10" /></>,
            'whatsapp': <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
        };

        const IconWrapper = ({ name, size = 24, className = "" }) => {
            const content = icons[name] || null;
            if (!content) return null;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="currentColor" className={className} style={{ display: 'inline-block', verticalAlign: 'middle' }}>
                    {content}
                </svg>
            );
        };

        // --- SUB-MÓDULO FINANCEIRO (DA OUTRA APP) ---
        // Ícones Específicos do Financeiro (Estilo Feather)
        const finIcons = {
            'dollar-sign': <><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></>,
            'trending-up': <><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></>,
            'trending-down': <><polyline points="23 18 13.5 8.5 8.5 13.5 1 6" /><polyline points="17 18 23 18 23 12" /></>,
            'credit-card': <><rect x="1" y="4" width="22" height="16" rx="2" ry="2" /><line x1="1" y1="10" x2="23" y2="10" /></>,
            'briefcase': <><rect width="20" height="14" x="2" y="7" rx="2" ry="2" /><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></>,
            'users': <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></>,
            'trash-2': <><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></>,
            'plus': <><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>,
            'download': <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></>,
            'refresh-cw': <><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path><path d="M3 22v-6h6"></path><path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path></>,
            'menu': <><line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" /></>,
            'calendar': <><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></>,
            'list': <><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></>,
            'pie-chart': <><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></>,
            'lock': <><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></>,
            'unlock': <><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></>,
            'file-text': <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></>,
            'clock': <circle cx="12" cy="12" r="10"></circle>,
            'check': <polyline points="20 6 9 17 4 12"></polyline>,
            'filter': <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>,
            'edit-2': <><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></>
        };

        const FinIconWrapper = ({ name, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={{ display: 'inline-block', verticalAlign: 'middle' }}>
                {finIcons[name] || null}
            </svg>
        );

        const SimplePieChart = ({ data, onSliceClick }) => {
            const validData = data.filter(d => d.value > 0);
            const total = validData.reduce((acc, item) => acc + item.value, 0);
            
            if (total === 0 && data.some(d => d.value !== 0)) {
                return <div className="text-center text-gray-400 p-4 text-sm">Gráfico indisponível para valores negativos/zerados.</div>;
            }
            if (total === 0) return <div className="text-center text-gray-400 p-4 text-sm">Sem dados para o gráfico</div>;
            
            let cumulativeAngle = 0;

            return (
                <div className="flex flex-col items-center bg-white p-6 rounded-xl shadow-lg border border-gray-100 mt-8 mb-8">
                    <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2"><FinIconWrapper name="pie-chart" className="text-purple-500"/> Distribuição Financeira</h3>
                    <p className="text-xs text-gray-400 mb-4">Toque nas fatias para ver detalhes</p>
                    <div className="relative w-48 h-48">
                        <svg viewBox="-1 -1 2 2" style={{ transform: 'rotate(-90deg)', width: '100%', height: '100%' }}>
                            {validData.map((slice, index) => {
                                const startAngle = cumulativeAngle;
                                const sliceAngle = (slice.value / total) * 2 * Math.PI;
                                cumulativeAngle += sliceAngle;

                                const x1 = Math.cos(startAngle);
                                const y1 = Math.sin(startAngle);
                                const x2 = Math.cos(startAngle + sliceAngle);
                                const y2 = Math.sin(startAngle + sliceAngle);

                                const largeArcFlag = sliceAngle > Math.PI ? 1 : 0;
                                
                                if (validData.length === 1) {
                                    return <circle 
                                        key={index} 
                                        cx="0" cy="0" r="1" 
                                        fill={slice.color} 
                                        onClick={() => onSliceClick && onSliceClick(slice.label)}
                                        style={{ cursor: 'pointer' }}
                                    />;
                                }

                                const pathData = [
                                    `M 0 0`,
                                    `L ${x1} ${y1}`,
                                    `A 1 1 0 ${largeArcFlag} 1 ${x2} ${y2}`,
                                    `Z`
                                ].join(' ');

                                return (
                                    <path 
                                        key={index} 
                                        d={pathData} 
                                        fill={slice.color} 
                                        stroke="white" 
                                        strokeWidth="0.05" 
                                        onClick={() => onSliceClick && onSliceClick(slice.label)}
                                        style={{ cursor: 'pointer' }}
                                    />
                                );
                            })}
                        </svg>
                    </div>
                    <div className="mt-6 w-full grid grid-cols-1 gap-3">
                        {data.map((item, i) => (
                            <div 
                                key={i} 
                                className="flex items-center justify-between p-2 rounded bg-gray-50 cursor-pointer hover:bg-gray-100 transition-colors"
                                onClick={() => onSliceClick && onSliceClick(item.label)}
                            >
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full shadow-sm" style={{backgroundColor: item.color}}></div>
                                    <span className="text-gray-600 text-xs font-bold uppercase">{item.label}</span>
                                </div>
                                <span className="font-bold text-gray-800 text-sm">R$ {item.value.toFixed(2)}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const FinancialModule = ({ onBack }) => {
            // ESTADOS GLOBAIS
            const [view, setView] = useState('transactions'); 
            
            // ESTADOS DE DADOS
            const [financialEntries, setFinancialEntries] = usePersistentState('financialEntries_v4', []);
            const [userAssets, setUserAssets] = usePersistentState('userAssets_v3', []);
            const [userLoans, setUserLoans] = usePersistentState('userLoans_v3', []);
            const [userCards, setUserCards] = usePersistentState('userCards_v3', []);
            const [userInvestments, setUserInvestments] = usePersistentState('userInvestments_v1', []);
            const [userDebts, setUserDebts] = usePersistentState('userDebts_v3', []); 
            const [expandedCardId, setExpandedCardId] = useState(null);
            const [expandedDebtId, setExpandedDebtId] = useState(null); // Corrigido: estado que faltava
            const [historyFilter, setHistoryFilter] = useState('all'); 
            
            // ESTADO DE EDIÇÃO
            const [editingId, setEditingId] = useState(null); 

            // ESTADOS DE SENHA
            const [appPassword, setAppPassword] = usePersistentState('appPassword', ''); 
            const [isLocked, setIsLocked] = useState(false); 
            const [pinInput, setPinInput] = useState(''); 
            const [newPasswordInput, setNewPasswordInput] = useState(''); 

            // FORMS
            const [finForm, setFinForm] = useState({ 
                date: new Date().toISOString().split('T')[0], 
                desc: '', value: '', type: 'expense', category: 'Outros', method: 'Dinheiro', installments: 1, cardId: '' 
            });
            const [assetForm, setAssetForm] = useState({ name: '', value: '' });
            const [loanForm, setLoanForm] = useState({ name: '', desc: '', value: '', date: '' });
            const [cardForm, setCardForm] = useState({ name: '', limit: '', dueDay: '' });
            const [investmentForm, setInvestmentForm] = useState({ type: 'Poupança', name: '', value: '' });
            const [debtForm, setDebtForm] = useState({ name: '', totalValue: '', installments: '', startDate: '', dueDay: '' });

            // EFEITO PARA FORÇAR O BLOQUEIO
            useEffect(() => {
                const savedPass = localStorage.getItem('appPassword');
                if (savedPass && savedPass !== '""') { 
                     setIsLocked(true);
                }
            }, []);

            // CÁLCULOS FINANCEIROS
            const summary = useMemo(() => {
                const realizedEntries = financialEntries.filter(e => e.status === 'paid');
                const income = realizedEntries.filter(e => e.type === 'income').reduce((acc, curr) => acc + curr.value, 0);
                const expense = realizedEntries.filter(e => e.type === 'expense').reduce((acc, curr) => acc + curr.value, 0);
                const pendingExpense = financialEntries.filter(e => e.status === 'pending' && e.type === 'expense').reduce((acc, curr) => acc + curr.value, 0);
                return { income, expense, balance: income - expense, pendingExpense };
            }, [financialEntries]);

            // CÁLCULOS GRÁFICO
            const chartData = useMemo(() => {
                const totalReceivable = userLoans.reduce((acc, curr) => acc + curr.value, 0);
                const totalCardDebt = financialEntries
                    .filter(e => e.method === 'Cartão Crédito' && e.type === 'expense')
                    .reduce((acc, curr) => acc + curr.value, 0);
                const currentBalance = summary.balance;
                return [
                    { label: 'Saldo em Caixa', value: currentBalance, color: '#10B981' }, 
                    { label: 'A Receber', value: totalReceivable, color: '#F59E0B' }, 
                    { label: 'Gasto c/ Cartão', value: totalCardDebt, color: '#EF4444' } 
                ];
            }, [userLoans, financialEntries, summary.balance]);

            // LÓGICA SENHA
            const handleUnlock = () => { if (pinInput === appPassword) { setIsLocked(false); setPinInput(''); } else { alert("Senha incorreta!"); setPinInput(''); } };
            const handleSetPassword = () => { if (newPasswordInput.length < 4) return alert("Mínimo 4 dígitos."); setAppPassword(newPasswordInput); setNewPasswordInput(''); alert("Senha definida!"); };
            const handleRemovePassword = () => { if (confirm("Remover proteção?")) { setAppPassword(''); alert("Senha removida."); } };

            // LÓGICA NAVEGAÇÃO GRÁFICO
            const handlePieClick = (label) => {
                if (label === 'Saldo em Caixa') setView('transactions');
                else if (label === 'A Receber') setView('loans');
                else if (label === 'Gasto c/ Cartão') setView('cards');
            };

            // LÓGICA FINANCEIRA AUXILIAR
            const getTotalCardUsage = (cardId) => {
                return financialEntries.filter(e => e.method === 'Cartão Crédito' && e.cardId === cardId && e.type === 'expense').reduce((acc, curr) => acc + curr.value, 0);
            };

            const getCurrentInvoiceValue = (cardId) => {
                const now = new Date();
                const currentMonth = now.getMonth(); 
                const currentYear = now.getFullYear();
                return financialEntries.filter(e => {
                        if (e.method !== 'Cartão Crédito' || e.cardId !== cardId || e.type !== 'expense') return false;
                        const [y, m, d] = e.date.split('-').map(Number);
                        return (m - 1) === currentMonth && y === currentYear;
                    }).reduce((acc, curr) => acc + curr.value, 0);
            };

            // ADD FLUXO
            const handleAddEntry = () => {
                if (!finForm.desc || !finForm.value) return alert("Preencha descrição e valor.");
                if (finForm.method === 'Cartão Crédito' && !finForm.cardId && userCards.length > 0) return alert("Selecione o cartão.");

                const totalValue = parseFloat(finForm.value);

                // LÓGICA DE EDIÇÃO
                if (editingId) {
                    if (!window.confirm("Confirma a alteração deste lançamento?")) return;
                    
                    setFinancialEntries(financialEntries.map(entry => {
                        if (entry.id === editingId) {
                            return {
                                ...entry,
                                date: finForm.date,
                                desc: finForm.desc,
                                value: totalValue,
                                type: finForm.type,
                                category: finForm.category,
                                method: finForm.method,
                                cardId: finForm.method === 'Cartão Crédito' ? finForm.cardId : null
                                // Mantém o status original
                            };
                        }
                        return entry;
                    }));
                    setEditingId(null); // Sai do modo edição
                    setFinForm({ ...finForm, desc: '', value: '', installments: 1 }); // Limpa form
                    alert("Registo atualizado!");
                    return;
                }

                // LÓGICA DE ADIÇÃO (NOVO)
                const numInstallments = parseInt(finForm.installments) || 1;
                const installmentValue = totalValue / numInstallments;
                const newEntries = [];
                
                let startDate; 
                
                if (finForm.method === 'Cartão Crédito' && finForm.cardId) {
                    const selectedCard = userCards.find(c => c.id === finForm.cardId);
                    if (selectedCard && selectedCard.dueDay) {
                        const dueDay = parseInt(selectedCard.dueDay);
                        const [y, m, d] = finForm.date.split('-').map(Number);
                        // Ajuste para mês 0-indexado
                        const purchaseDate = new Date(y, m - 1, d);
                        
                        let nextMonth = purchaseDate.getMonth() + 1;
                        let year = purchaseDate.getFullYear();
                        if (nextMonth > 11) { nextMonth = 0; year++; }
                        
                        startDate = new Date(year, nextMonth, dueDay);
                    } else {
                         // Fallback
                         const [y, m, d] = finForm.date.split('-').map(Number);
                         startDate = new Date(y, m - 1, d);
                         startDate.setMonth(startDate.getMonth() + 1);
                    }
                } else if (finForm.method === 'Carnê/Boleto') {
                    const [y, m, d] = finForm.date.split('-').map(Number);
                    startDate = new Date(y, m - 1, d);
                } else {
                    const [y, m, d] = finForm.date.split('-').map(Number);
                    startDate = new Date(y, m - 1, d);
                }

                for (let i = 0; i < numInstallments; i++) {
                    const entryDate = new Date(startDate);
                    
                    // Incrementa meses
                    if (['Cartão Crédito', 'Carnê/Boleto'].includes(finForm.method)) {
                        entryDate.setMonth(startDate.getMonth() + i);
                    } else if (i > 0) {
                        entryDate.setMonth(startDate.getMonth() + i);
                    }
                    
                    const y = entryDate.getFullYear();
                    const m = String(entryDate.getMonth() + 1).padStart(2, '0');
                    const d = String(entryDate.getDate()).padStart(2, '0');
                    const dateStr = `${y}-${m}-${d}`;

                    let initialStatus = 'pending';
                    const today = new Date(); today.setHours(0,0,0,0);
                    const checkDate = new Date(entryDate); checkDate.setHours(0,0,0,0);
                    
                    if (['Dinheiro', 'Cartão Débito', 'Pix'].includes(finForm.method) && checkDate <= today) {
                        initialStatus = 'paid';
                    }

                    newEntries.push({
                        id: Date.now() + i,
                        date: dateStr,
                        desc: numInstallments > 1 ? `${finForm.desc} (${i + 1}/${numInstallments})` : finForm.desc,
                        value: installmentValue,
                        type: finForm.type,
                        category: finForm.category,
                        method: finForm.method,
                        cardId: finForm.method === 'Cartão Crédito' ? finForm.cardId : null,
                        status: initialStatus
                    });
                }
                
                setFinancialEntries([...newEntries, ...financialEntries]);
                setFinForm({ ...finForm, desc: '', value: '', installments: 1 });
                alert("Lançamento(s) adicionado(s) ao Fluxo!");
            };

            const handleEditEntry = (entry) => {
                setEditingId(entry.id);
                setFinForm({
                    date: entry.date, desc: entry.desc, value: entry.value, type: entry.type,
                    category: entry.category, method: entry.method, installments: 1, cardId: entry.cardId || ''
                });
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            const cancelEdit = () => { setEditingId(null); setFinForm({ ...finForm, desc: '', value: '', installments: 1 }); };
            
            const handleAddAsset = () => { if (!assetForm.name || !assetForm.value) return alert("Preencha campos."); setUserAssets([...userAssets, { id: Date.now(), ...assetForm, value: parseFloat(assetForm.value) }]); setAssetForm({ name: '', value: '' }); };
            
            // --- NOVO HANDLE ADD LOAN (INTEGRADO AO FLUXO) ---
            const handleAddLoan = () => {
                if (!loanForm.name || !loanForm.value || !loanForm.date) return alert("Preencha todos os campos (Nome, Valor, Data).");
                
                const newLoanId = Date.now().toString();
                const loanValue = parseFloat(loanForm.value);
                
                // 1. Cria o registro na aba 'Receber' (Controle Geral)
                const newLoan = { 
                    id: newLoanId, 
                    ...loanForm, 
                    value: loanValue 
                };

                // 2. Cria automaticamente a entrada no Fluxo de Caixa (Pendente)
                const newEntry = {
                    id: Date.now() + 1, // ID diferente do loan
                    date: loanForm.date,
                    desc: `Recebimento: ${loanForm.name} - ${loanForm.desc}`,
                    value: loanValue,
                    type: 'income',      // Tipo Receita
                    category: 'Empréstimos', // Categoria Automática
                    method: 'Dinheiro',  // Método padrão (pode ser editado depois)
                    status: 'pending',   // Entra como pendente (a receber)
                    loanId: newLoanId    // Link para permitir exclusão conjunta
                };

                setUserLoans([...userLoans, newLoan]);
                setFinancialEntries([newEntry, ...financialEntries]);
                
                setLoanForm({ name: '', desc: '', value: '', date: '' });
                alert("Registrado em 'Receber' e adicionado ao Fluxo como Pendente!");
            };

            const handleAddCard = () => { if (!cardForm.name || !cardForm.limit || !cardForm.dueDay) return alert("Preencha campos."); setUserCards([...userCards, { id: Date.now().toString(), ...cardForm, limit: parseFloat(cardForm.limit), dueDay: cardForm.dueDay }]); setCardForm({ name: '', limit: '', dueDay: '' }); };
            const handleAddInvestment = () => { if (!investmentForm.name || !investmentForm.value) return alert("Preencha campos."); setUserInvestments([...userInvestments, { id: Date.now(), ...investmentForm, value: parseFloat(investmentForm.value) }]); setInvestmentForm({ type: 'Poupança', name: '', value: '' }); };

            const handleAddDebt = () => {
                if (!debtForm.name || !debtForm.totalValue || !debtForm.installments || !debtForm.dueDay) return alert("Preencha todos os campos.");
                
                const newDebtId = Date.now().toString();
                const installments = parseInt(debtForm.installments);
                const totalValue = parseFloat(debtForm.totalValue);
                const installmentValue = totalValue / installments;
                const dueDay = parseInt(debtForm.dueDay);
                
                const today = new Date();
                let startMonth = today.getMonth();
                let startYear = today.getFullYear();
                
                if (today.getDate() >= dueDay) {
                    startMonth++;
                    if(startMonth > 11) { startMonth = 0; startYear++; }
                }
                
                const debtStartDate = new Date(startYear, startMonth, dueDay);
                const newEntries = [];

                for (let i = 0; i < installments; i++) {
                    const entryDate = new Date(debtStartDate);
                    entryDate.setMonth(debtStartDate.getMonth() + i);
                    
                    const y = entryDate.getFullYear();
                    const m = String(entryDate.getMonth() + 1).padStart(2, '0');
                    const d = String(entryDate.getDate()).padStart(2, '0');
                    
                    newEntries.push({
                        id: Date.now() + i,
                        date: `${y}-${m}-${d}`,
                        desc: `${debtForm.name} (${i + 1}/${installments})`,
                        value: installmentValue,
                        type: 'expense',
                        category: 'Dívida/Financ.',
                        method: 'Carnê/Boleto',
                        status: 'pending',
                        debtId: newDebtId 
                    });
                }

                setUserDebts([...userDebts, { 
                    id: newDebtId, 
                    ...debtForm, 
                    totalValue: totalValue,
                    installments: installments
                }]);

                setFinancialEntries([...newEntries, ...financialEntries]);
                
                setDebtForm({ name: '', totalValue: '', installments: '', startDate: '', dueDay: '' });
                alert("Dívida cadastrada e parcelas geradas no Fluxo de Caixa!");
            };

            const deleteItem = (id, list, setList) => { if(confirm("Excluir item?")) setList(list.filter(i => i.id !== id)); };
            
            // --- NOVA FUNÇÃO DE LIXEIRA INTELIGENTE ---
            const handleTrashClick = (entry) => {
                if (entry.status === 'paid') {
                    if (confirm("Ocultar item do histórico? O valor continuará contabilizado no Saldo. (Para apagar definitivamente, vá em Configurações > Segurança)")) {
                        // Soft delete: apenas marca como oculto, mas mantem no array
                        setFinancialEntries(financialEntries.map(e => e.id === entry.id ? { ...e, hidden: true } : e));
                    }
                } else {
                    // Se for pendente, apaga de verdade pois não afeta saldo realizado
                    if (confirm("Excluir lançamento pendente permanentemente?")) {
                        setFinancialEntries(financialEntries.filter(e => e.id !== entry.id));
                    }
                }
            };
            
            // --- NOVA FUNÇÃO DE EXCLUSÃO INDIVIDUAL DO HISTÓRICO OCULTO ---
            const deleteHiddenItem = (id) => {
                if(confirm("Tem certeza? Isso apagará este item definitivamente e ALTERARÁ o seu Saldo.")) {
                    setFinancialEntries(financialEntries.filter(e => e.id !== id));
                }
            };

            const clearHiddenItems = () => {
                const count = financialEntries.filter(e => e.hidden).length;
                if (count === 0) return alert("Não há itens ocultos.");
                if(confirm(`Tem certeza? Isso apagará definitivamente ${count} itens ocultos e ALTERARÁ o seu Saldo atual. Essa ação não pode ser desfeita.`)) {
                    setFinancialEntries(financialEntries.filter(e => !e.hidden));
                    alert("Itens apagados e saldo recalculado.");
                }
            };

            const deleteDebt = (id) => { if(confirm("Apagar dívida e todas as parcelas pendentes?")) { setUserDebts(userDebts.filter(d => d.id !== id)); setFinancialEntries(financialEntries.filter(e => !(e.debtId === id && e.status === 'pending'))); } };
            
            // --- NOVA FUNÇÃO PARA APAGAR RECEBÍVEIS (E REMOVER DO FLUXO) ---
            const deleteLoan = (id) => {
                if(confirm("Apagar registro em 'Receber' e remover a entrada pendente do Fluxo?")) {
                    setUserLoans(userLoans.filter(l => l.id !== id));
                    // Remove do fluxo apenas se ainda estiver 'pending'. Se já pagou, mantém o histórico.
                    setFinancialEntries(financialEntries.filter(e => !(e.loanId === id && e.status === 'pending')));
                }
            };

            const toggleEntryStatus = (id) => {
                setFinancialEntries(financialEntries.map(entry => {
                    if (entry.id === id) return { ...entry, status: entry.status === 'paid' ? 'pending' : 'paid' };
                    return entry;
                }));
            };

            const exportData = () => { const dataStr = JSON.stringify({ financialEntries, userAssets, userLoans, userCards, userInvestments, userDebts }, null, 2); const blob = new Blob([dataStr], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = `backup_financeiro_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const importData = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (evt) => { try { const data = JSON.parse(evt.target.result); if (confirm("Restaurar backup?")) { if(data.financialEntries) setFinancialEntries(data.financialEntries); if(data.userAssets) setUserAssets(data.userAssets); if(data.userLoans) setUserLoans(data.userLoans); if(data.userCards) setUserCards(data.userCards); if(data.userInvestments) setUserInvestments(data.userInvestments); if(data.userDebts) setUserDebts(data.userDebts); alert("Sucesso!"); } } catch { alert("Erro."); } }; reader.readAsText(file); e.target.value = ''; };

            const getCardName = (cardId) => { const card = userCards.find(c => c.id === cardId); return card ? card.name : 'Cartão Excluído'; };
            const toggleCardDetails = (cardId) => { setExpandedCardId(expandedCardId === cardId ? null : cardId); };
            const isOverdue = (dateStr) => { if (!dateStr) return false; const [y, m, d] = dateStr.split('-').map(Number); const date = new Date(y, m-1, d); const today = new Date(); today.setHours(0,0,0,0); return date < today; };
            
            const getDebtProgress = (debtId) => {
                const debtEntries = financialEntries.filter(e => e.debtId === debtId);
                const paidCount = debtEntries.filter(e => e.status === 'paid').length;
                const totalEntries = debtEntries.length > 0 ? debtEntries.length : 1;
                return { paid: paidCount, total: totalEntries };
            };

            const filteredEntries = useMemo(() => {
                return financialEntries.filter(entry => {
                    if (entry.hidden) return false; // Esconde os itens "soft deleted"
                    if (historyFilter === 'all') return true;
                    if (historyFilter === 'paid') return entry.status === 'paid';
                    if (historyFilter === 'pending') return entry.status === 'pending';
                    return true;
                });
            }, [financialEntries, historyFilter]);

            if (isLocked) {
                return ( <div className="min-h-screen flex flex-col items-center justify-center bg-gray-900 text-white p-4 animate-fadeIn"> <div className="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center"> <div className="mb-6 text-yellow-400"><FinIconWrapper name="lock" size={64} /></div> <h2 className="text-2xl font-bold mb-2">Agenda Bloqueada</h2> <p className="text-gray-400 mb-6 text-sm">Proteção Ativa.</p> <input type="password" value={pinInput} onChange={(e) => setPinInput(e.target.value)} className="w-full p-4 text-center text-2xl bg-gray-700 rounded-lg border border-gray-600 text-white mb-4 tracking-widest outline-none focus:border-yellow-500 transition-colors" placeholder="****" maxLength="6" inputMode="numeric" /> <button onClick={handleUnlock} className="w-full bg-yellow-500 text-gray-900 font-bold py-3 rounded-lg hover:bg-yellow-400 transition-transform active:scale-95">Desbloquear</button> </div> </div> );
            }

            return (
                <div className="flex flex-col bg-gray-100 min-h-screen">
                    <header className="bg-red-800 text-white p-4 shadow-lg sticky top-0 z-50">
                        <div className="container mx-auto flex justify-between items-center">
                            <h1 className="text-xl font-bold flex items-center gap-2"><FinIconWrapper name="dollar-sign" className="text-yellow-400" size={24}/> Agenda Financeira</h1>
                            <div className="flex gap-2">
                                <button onClick={onBack} className="p-2 bg-red-900 rounded hover:bg-red-700 font-bold text-xs uppercase flex items-center gap-1">Voltar</button>
                                <button onClick={() => setView('settings')} className="p-2 bg-red-700 rounded hover:bg-red-600"><FinIconWrapper name="lock" size={20} /></button>
                                <button onClick={exportData} className="p-2 bg-red-700 rounded hover:bg-red-600"><FinIconWrapper name="download"/></button>
                                <label className="p-2 bg-red-700 rounded hover:bg-red-600 cursor-pointer"><input type="file" onChange={importData} className="hidden" accept=".json" /><FinIconWrapper name="refresh-cw"/></label>
                            </div>
                        </div>
                    </header>

                    <div className="bg-white shadow px-4 pt-4 pb-2 sticky top-16 z-40">
                        <div className="flex space-x-1 overflow-x-auto hide-scrollbar">
                            <button onClick={() => setView('transactions')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap transition-colors ${view === 'transactions' ? 'bg-red-100 text-red-800' : 'text-gray-500 hover:bg-gray-50'}`}>Fluxo</button>
                            <button onClick={() => setView('cards')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap transition-colors ${view === 'cards' ? 'bg-purple-100 text-purple-800' : 'text-gray-500 hover:bg-gray-50'}`}>Cartões</button>
                            <button onClick={() => setView('investments')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap transition-colors ${view === 'investments' ? 'bg-teal-100 text-teal-800' : 'text-gray-500 hover:bg-gray-50'}`}>Invest.</button>
                            <button onClick={() => setView('debts')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap transition-colors ${view === 'debts' ? 'bg-indigo-100 text-indigo-800' : 'text-gray-500 hover:bg-gray-50'}`}>Dívidas</button>
                            <button onClick={() => setView('assets')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap transition-colors ${view === 'assets' ? 'bg-blue-100 text-blue-800' : 'text-gray-500 hover:bg-gray-50'}`}>Bens</button>
                            <button onClick={() => setView('loans')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold whitespace-nowrap transition-colors ${view === 'loans' ? 'bg-orange-100 text-orange-800' : 'text-gray-500 hover:bg-gray-50'}`}>Receber</button>
                        </div>
                    </div>

                    <main className="container mx-auto p-4 flex-grow animate-fadeIn">
                        
                        {view === 'settings' && (
                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded-xl shadow border border-gray-100 text-center">
                                    <div className="mb-4 text-gray-600"><FinIconWrapper name="lock" size={48} className="mx-auto text-gray-400"/></div>
                                    <h3 className="font-bold text-xl text-gray-800 mb-2">Segurança</h3>
                                    {appPassword ? (
                                        <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                                            <p className="text-green-700 font-bold mb-4">✓ Proteção Ativa</p>
                                            <button onClick={handleRemovePassword} className="w-full bg-red-500 text-white py-2 rounded font-bold hover:bg-red-600">Remover Senha</button>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            <input type="password" placeholder="Nova Senha (mín. 4)" className="w-full p-3 border rounded-lg text-center text-lg tracking-widest bg-gray-50" value={newPasswordInput} onChange={(e) => setNewPasswordInput(e.target.value)} inputMode="numeric"/>
                                            <button onClick={handleSetPassword} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">Ativar Proteção</button>
                                        </div>
                                    )}

                                    {/* ÁREA DE LIMPEZA DE HISTÓRICO OCULTO */}
                                    {financialEntries.filter(e => e.hidden).length > 0 && (
                                        <div className="bg-orange-50 p-4 rounded-lg border border-orange-200 mt-6 text-left">
                                            <h4 className="font-bold text-orange-800 mb-2 flex items-center gap-2"><FinIconWrapper name="trash-2" size={16}/> Histórico Oculto</h4>
                                            <p className="text-sm text-orange-700 mb-3">
                                                Existem <strong>{financialEntries.filter(e => e.hidden).length}</strong> itens pagos que foram ocultados da lista principal, mas <strong>ainda estão somando no seu Saldo</strong>.
                                            </p>
                                            
                                            {/* LISTA DETALHADA PARA EXCLUSÃO INDIVIDUAL */}
                                            <ul className="mt-3 space-y-2 max-h-60 overflow-y-auto mb-4">
                                                {financialEntries.filter(e => e.hidden).map(entry => (
                                                    <li key={entry.id} className="flex justify-between items-center bg-white p-2 rounded border border-orange-100 shadow-sm">
                                                         <div>
                                                             <div className="font-bold text-gray-700 text-xs">{entry.desc}</div>
                                                             <div className="text-[10px] text-gray-500">{new Date(entry.date).toLocaleDateString('pt-BR')} • R$ {entry.value.toFixed(2)}</div>
                                                         </div>
                                                         <button onClick={() => deleteHiddenItem(entry.id)} className="text-red-500 hover:text-red-700 text-xs font-bold px-2 py-1 border border-red-200 rounded bg-red-50">
                                                             Apagar
                                                         </button>
                                                    </li>
                                                ))}
                                            </ul>

                                            <button onClick={clearHiddenItems} className="w-full bg-orange-600 text-white py-2 rounded font-bold hover:bg-orange-700 text-sm">
                                                Limpar Todos Definitivamente (Alterará o Saldo)
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'transactions' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-3 gap-2 text-center">
                                    <div className="bg-green-100 p-3 rounded-xl border border-green-200">
                                        <div className="text-[10px] font-bold text-green-700 uppercase tracking-wide">Entradas</div>
                                        <div className="text-sm font-bold text-green-800">R$ {summary.income.toFixed(2)}</div>
                                    </div>
                                    <div className="bg-red-100 p-3 rounded-xl border border-red-200">
                                        <div className="text-[10px] font-bold text-red-700 uppercase tracking-wide">Saídas</div>
                                        <div className="text-sm font-bold text-red-800">R$ {summary.expense.toFixed(2)}</div>
                                    </div>
                                    <div className={`p-3 rounded-xl border-l-4 shadow-sm bg-white ${summary.balance >= 0 ? 'border-green-500' : 'border-red-500'}`}>
                                        <div className="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Saldo</div>
                                        <div className={`text-sm font-bold ${summary.balance >= 0 ? 'text-gray-800' : 'text-red-600'}`}>R$ {summary.balance.toFixed(2)}</div>
                                    </div>
                                </div>
                                {summary.pendingExpense > 0 && <div className="bg-yellow-50 p-2 rounded border border-yellow-200 text-center text-xs text-yellow-700 font-bold">A Pagar (Pendente): R$ {summary.pendingExpense.toFixed(2)}</div>}

                                <div className="bg-white p-4 rounded-xl shadow border border-gray-100">
                                    <h3 className="font-bold text-gray-700 mb-3 text-sm flex justify-between items-center">
                                        {editingId ? 'Editar' : 'Nova Movimentação'}
                                        {editingId && <button onClick={cancelEdit} className="text-xs text-red-500 underline">Cancelar</button>}
                                    </h3>
                                    <div className="space-y-3">
                                        <div className="grid grid-cols-2 gap-3">
                                            <input type="date" className="w-full p-2 border rounded text-sm bg-gray-50" value={finForm.date} onChange={e => setFinForm({...finForm, date: e.target.value})} />
                                            <input type="number" placeholder="Valor (R$)" className="w-full p-2 border rounded text-sm bg-gray-50" value={finForm.value} onChange={e => setFinForm({...finForm, value: e.target.value})} />
                                        </div>
                                        <input type="text" placeholder="Descrição" className="w-full p-2 border rounded text-sm bg-gray-50" value={finForm.desc} onChange={e => setFinForm({...finForm, desc: e.target.value})} />
                                        
                                        <div className="grid grid-cols-2 gap-3">
                                            <select className="w-full p-2 border rounded text-sm bg-gray-50" value={finForm.category} onChange={e => setFinForm({...finForm, category: e.target.value})}>
                                                <option>Outros</option><option>Dízimo</option><option>Oferta</option><option>Alimentação</option><option>Contas</option><option>Transporte</option><option>Saúde</option><option>Lazer</option><option>Salário</option>
                                            </select>
                                            <select className="w-full p-2 border rounded text-sm bg-gray-50" value={finForm.method} onChange={e => setFinForm({...finForm, method: e.target.value})}>
                                                <option>Dinheiro</option><option>Cartão Crédito</option><option>Cartão Débito</option><option>Pix</option>
                                                <option>Carnê/Boleto</option>
                                            </select>
                                        </div>

                                        {/* CARTÃO */}
                                        {finForm.method === 'Cartão Crédito' && (
                                            <div className="bg-yellow-50 p-3 rounded space-y-2">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-xs font-bold text-yellow-800">Cartão:</span>
                                                    <select className="w-full p-1 border rounded text-sm" value={finForm.cardId} onChange={e => setFinForm({...finForm, cardId: e.target.value})}>
                                                        <option value="">Selecione...</option>
                                                        {userCards.map(card => <option key={card.id} value={card.id}>{card.name}</option>)}
                                                    </select>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-xs font-bold text-yellow-800">Parcelas:</span>
                                                    <input type="number" min="1" max="48" className="w-16 p-1 border rounded text-sm" value={finForm.installments} onChange={e => setFinForm({...finForm, installments: e.target.value})} />
                                                </div>
                                            </div>
                                        )}
                                        {/* CARNÊ/BOLETO */}
                                        {finForm.method === 'Carnê/Boleto' && !editingId && (
                                            <div className="bg-blue-50 p-3 rounded space-y-2">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-xs font-bold text-blue-800">Parcelas:</span>
                                                    <input type="number" min="1" max="48" className="w-16 p-1 border rounded text-sm" value={finForm.installments} onChange={e => setFinForm({...finForm, installments: e.target.value})} />
                                                </div>
                                            </div>
                                        )}

                                        <div className="flex gap-2 pt-2">
                                            <button onClick={() => setFinForm({...finForm, type: 'income'})} className={`flex-1 py-2 rounded text-sm font-bold transition ${finForm.type === 'income' ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-400'}`}>Receita</button>
                                            <button onClick={() => setFinForm({...finForm, type: 'expense'})} className={`flex-1 py-2 rounded text-sm font-bold transition ${finForm.type === 'expense' ? 'bg-red-600 text-white' : 'bg-gray-100 text-gray-400'}`}>Despesa</button>
                                        </div>
                                        <button onClick={handleAddEntry} className="w-full bg-gray-800 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-gray-700 mt-2 flex justify-center items-center gap-2"><FinIconWrapper name={editingId ? 'edit-2' : 'plus'}/> {editingId ? 'Atualizar' : 'Adicionar'}</button>
                                    </div>
                                </div>

                                {/* LISTA */}
                                <div className="bg-white rounded-xl shadow overflow-hidden">
                                    <div className="flex justify-between items-center bg-gray-50 px-4 py-2">
                                        <span className="font-bold text-xs text-gray-500 uppercase">Histórico</span>
                                        <div className="flex gap-2">
                                            <button onClick={() => setHistoryFilter('all')} className={`text-[10px] font-bold px-2 py-1 rounded ${historyFilter === 'all' ? 'bg-gray-200' : 'text-gray-400'}`}>Todos</button>
                                            <button onClick={() => setHistoryFilter('pending')} className={`text-[10px] font-bold px-2 py-1 rounded ${historyFilter === 'pending' ? 'bg-yellow-100 text-yellow-700' : 'text-gray-400'}`}>Pendentes</button>
                                            <button onClick={() => setHistoryFilter('paid')} className={`text-[10px] font-bold px-2 py-1 rounded ${historyFilter === 'paid' ? 'bg-green-100 text-green-700' : 'text-gray-400'}`}>Pagos</button>
                                        </div>
                                    </div>
                                    <ul className="divide-y divide-gray-100">
                                        {filteredEntries.length === 0 ? <li className="p-4 text-center text-gray-400 text-sm">Sem registos visíveis.</li> : 
                                        filteredEntries.sort((a,b) => new Date(a.date) - new Date(b.date)).map(entry => (
                                            <li key={entry.id} className={`p-4 flex justify-between items-center ${entry.status === 'paid' ? 'bg-white opacity-75' : 'bg-white'}`}>
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2">
                                                        <span className={`font-bold ${entry.status === 'paid' ? 'text-gray-500 line-through' : 'text-gray-800'}`}>{entry.desc}</span>
                                                        <span className="text-[10px] px-2 py-0.5 bg-gray-100 rounded text-gray-500">{entry.category}</span>
                                                    </div>
                                                    <div className="text-xs text-gray-400 mt-1 flex flex-wrap items-center gap-1">
                                                        {new Date(entry.date).toLocaleDateString('pt-BR')} • {entry.method}
                                                        {entry.method === 'Cartão Crédito' && entry.cardId && (
                                                            <span className="bg-purple-100 text-purple-700 px-1 rounded border border-purple-200 text-[10px]">
                                                                {getCardName(entry.cardId)}
                                                            </span>
                                                        )}
                                                        {isOverdue(entry.date) && entry.status !== 'paid' && entry.type === 'expense' && <span className="text-red-500 font-bold ml-1 bg-red-100 px-1 rounded">Vencido</span>}
                                                    </div>
                                                </div>
                                                <div className="text-right flex flex-col items-end gap-2">
                                                    <div className={`font-bold ${entry.type === 'income' ? 'text-green-600' : 'text-red-600'} ${entry.status === 'pending' ? '' : 'opacity-50'}`}>
                                                        {entry.type === 'income' ? '+' : '-'} {parseFloat(entry.value).toFixed(2)}
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => handleEditEntry(entry)} className="w-8 h-8 flex items-center justify-center rounded-full border border-gray-200 text-gray-400 hover:bg-blue-50 hover:text-blue-500 transition-all"><FinIconWrapper name="edit-2" size={14}/></button>
                                                        <button onClick={() => toggleEntryStatus(entry.id)} className={`w-8 h-8 flex items-center justify-center rounded-full border transition-all ${entry.status === 'paid' ? 'bg-green-500 border-green-600 text-white' : 'bg-white border-gray-300 text-gray-300'}`}><FinIconWrapper name="check" size={16} /></button>
                                                        {/* LIXEIRA INTELIGENTE AQUI */}
                                                        <button onClick={() => handleTrashClick(entry)} className="w-8 h-8 flex items-center justify-center rounded-full border border-gray-200 text-gray-300 hover:bg-red-50 hover:text-red-500 transition-all"><FinIconWrapper name="trash-2" size={14}/></button>
                                                    </div>
                                                </div>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                                <SimplePieChart data={chartData} onSliceClick={handlePieClick} />
                            </div>
                        )}

                        {view === 'cards' && (
                            <div className="space-y-6">
                                <div className="bg-white p-4 rounded-xl shadow">
                                    <h3 className="font-bold text-purple-700 mb-3 text-sm flex items-center gap-2"><FinIconWrapper name="credit-card"/> Novo Cartão</h3>
                                    <div className="flex gap-2 mb-2">
                                        <input type="text" placeholder="Nome" className="flex-1 p-2 border rounded text-sm" value={cardForm.name} onChange={e => setCardForm({...cardForm, name: e.target.value})} />
                                        <input type="number" placeholder="Limite" className="w-24 p-2 border rounded text-sm" value={cardForm.limit} onChange={e => setCardForm({...cardForm, limit: e.target.value})} />
                                        <input type="number" placeholder="Dia Venc." min="1" max="31" className="w-20 p-2 border rounded text-sm" value={cardForm.dueDay} onChange={e => setCardForm({...cardForm, dueDay: e.target.value})} />
                                    </div>
                                    <button onClick={handleAddCard} className="w-full bg-purple-600 text-white py-2 rounded font-bold hover:bg-purple-700">Adicionar Cartão</button>
                                </div>
                                
                                <div className="space-y-4">
                                    {userCards.map(card => {
                                        const totalUsed = getTotalCardUsage(card.id); 
                                        const currentInvoice = getCurrentInvoiceValue(card.id); 
                                        const available = card.limit - totalUsed; 
                                        const percentUsed = Math.min(100, (totalUsed / card.limit) * 100);
                                        
                                        // Filtra os lançamentos deste cartão que ainda não foram pagos (parcelas futuras/atuais)
                                        const cardEntries = financialEntries
                                            .filter(e => e.cardId === card.id && e.status === 'pending')
                                            .sort((a,b) => new Date(a.date) - new Date(b.date));

                                        return (
                                            <div key={card.id} className="bg-white rounded-xl shadow-lg overflow-hidden transition-all">
                                                {/* Área clicável para expandir */}
                                                <div 
                                                    onClick={() => toggleCardDetails(card.id)}
                                                    className="bg-gradient-to-r from-gray-800 to-gray-700 p-5 text-white relative cursor-pointer hover:opacity-95"
                                                >
                                                    <div className="flex justify-between items-start mb-4">
                                                        <div><h4 className="font-bold text-lg">{card.name}</h4><span className="text-xs text-gray-400">Vence dia {card.dueDay}</span></div>
                                                        <FinIconWrapper name="credit-card" className="text-gray-500 opacity-50" size={32}/>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-4 text-sm mb-4">
                                                        <div><div className="text-xs text-gray-400">Fatura Atual (Mês)</div><div className="font-bold text-red-300">R$ {currentInvoice.toFixed(2)}</div></div>
                                                        <div className="text-right"><div className="text-xs text-gray-400">Disponível</div><div className="font-bold text-green-300">R$ {available.toFixed(2)}</div></div>
                                                    </div>
                                                    <div className="w-full bg-gray-600 h-2 rounded-full overflow-hidden mb-2">
                                                        <div className={`h-full ${percentUsed > 90 ? 'bg-red-500' : 'bg-green-500'}`} style={{width: `${percentUsed}%`}}></div>
                                                    </div>
                                                    
                                                    {/* Botão de Excluir Cartão */}
                                                    <button onClick={(e) => { e.stopPropagation(); deleteItem(card.id, userCards, setUserCards); }} className="absolute top-2 right-2 text-gray-500 hover:text-red-400"><FinIconWrapper name="trash-2" size={16}/></button>
                                                    
                                                    {/* Indicador visual de expandir */}
                                                    <div className="text-center text-[10px] text-gray-400 mt-1">
                                                        {expandedCardId === card.id ? '▲ Ocultar Detalhes' : '▼ Ver Parcelas e Fatura'}
                                                    </div>
                                                </div>

                                                {/* Lista de Parcelas (Só aparece se clicar) */}
                                                {expandedCardId === card.id && (
                                                    <div className="bg-gray-50 p-4 border-t border-gray-200 animate-fadeIn">
                                                        <h5 className="font-bold text-gray-500 text-xs uppercase mb-3">Parcelas a Vencer (Fatura Aberta e Futuras)</h5>
                                                        {cardEntries.length === 0 ? (
                                                            <p className="text-center text-sm text-gray-400">Nenhuma compra pendente neste cartão.</p>
                                                        ) : (
                                                            <ul className="space-y-2">
                                                                {cardEntries.map(entry => (
                                                                    <li key={entry.id} className="flex justify-between items-center bg-white p-3 rounded border border-gray-100 shadow-sm">
                                                                        <div>
                                                                            <div className="font-bold text-gray-800 text-sm">{entry.desc}</div>
                                                                            <div className="text-xs text-gray-500">{new Date(entry.date).toLocaleDateString('pt-BR')} • {entry.category}</div>
                                                                        </div>
                                                                        <div className="font-bold text-red-600 text-sm">
                                                                            R$ {entry.value.toFixed(2)}
                                                                        </div>
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                        )}
                                                        <div className="mt-4 pt-2 border-t border-gray-200 text-right">
                                                            <span className="text-xs font-bold text-gray-500 uppercase mr-2">Total Pendente:</span>
                                                            <span className="font-bold text-gray-800">R$ {cardEntries.reduce((acc, curr) => acc + curr.value, 0).toFixed(2)}</span>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                        
                        {view === 'debts' && (
                            <div className="space-y-6">
                                <div className="bg-indigo-600 p-6 rounded-2xl shadow-lg text-white text-center"><div className="text-xs font-bold uppercase opacity-80 mb-1">Total Dívidas Longas</div><div className="text-3xl font-bold">R$ {userDebts.reduce((acc, curr) => acc + (curr.totalValue - (curr.totalValue/curr.installments * (getDebtProgress(curr.id).paid))), 0).toFixed(2)}</div></div>
                                <div className="bg-white p-4 rounded-xl shadow border border-indigo-100">
                                    <h3 className="font-bold text-gray-700 mb-3 text-sm flex items-center gap-2"><FinIconWrapper name="briefcase"/> Nova Dívida/Financiamento</h3>
                                    <div className="grid grid-cols-1 gap-3">
                                        <input type="text" placeholder="Nome (Ex: Casa)" className="w-full p-2 border rounded text-sm bg-gray-50" value={debtForm.name} onChange={e => setDebtForm({...debtForm, name: e.target.value})} />
                                        <div className="flex gap-2">
                                            <input type="number" placeholder="Valor Total" className="flex-1 p-2 border rounded text-sm" value={debtForm.totalValue} onChange={e => setDebtForm({...debtForm, totalValue: e.target.value})} />
                                            <input type="number" placeholder="Parcelas" className="w-24 p-2 border rounded text-sm" value={debtForm.installments} onChange={e => setDebtForm({...debtForm, installments: e.target.value})} />
                                        </div>
                                        <div className="flex gap-2">
                                            <div className="flex-1">
                                                <label className="block text-[10px] font-bold text-gray-400 mb-1">Dia Vencimento</label>
                                                <input type="number" min="1" max="31" className="w-full p-2 border rounded text-sm bg-gray-50" value={debtForm.dueDay} onChange={e => setDebtForm({...debtForm, dueDay: e.target.value})} placeholder="Dia" />
                                            </div>
                                            <div className="flex-1 flex items-end"><button onClick={handleAddDebt} className="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700">Salvar</button></div>
                                        </div>
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    {userDebts.map(debt => {
                                        const { paid, total } = getDebtProgress(debt.id);
                                        const remaining = debt.totalValue - ((debt.totalValue/debt.installments) * paid);
                                        const progress = (paid / debt.installments) * 100;
                                        return (
                                            <div key={debt.id} className="bg-white rounded-xl shadow-lg overflow-hidden border-l-4 border-indigo-500">
                                                <div className="p-4">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <h4 className="font-bold text-indigo-900 text-lg">{debt.name}</h4>
                                                        <button onClick={() => deleteDebt(debt.id)} className="text-gray-400 hover:text-red-500"><FinIconWrapper name="trash-2" size={16}/></button>
                                                    </div>
                                                    <div className="flex justify-between text-xs text-gray-500 mb-2">
                                                        <span>Pago: {paid}/{debt.installments}</span>
                                                        <span>Restante: R$ {remaining.toFixed(2)}</span>
                                                    </div>
                                                    <div className="w-full bg-gray-200 h-3 rounded-full overflow-hidden mb-3">
                                                        <div className="h-full bg-indigo-500 transition-all duration-500" style={{width: `${progress}%`}}></div>
                                                    </div>
                                                    <p className="text-[10px] text-center text-gray-400">Gerencie as parcelas na aba FLUXO.</p>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {view === 'investments' && (
                            <div className="space-y-6">
                                <div className="bg-teal-600 p-6 rounded-2xl shadow-lg text-white text-center"><div className="text-xs font-bold uppercase opacity-80 mb-1">Total Investido</div><div className="text-3xl font-bold">R$ {userInvestments.reduce((acc, curr) => acc + curr.value, 0).toFixed(2)}</div></div>
                                <div className="bg-white p-4 rounded-xl shadow"><h3 className="font-bold text-gray-700 mb-3 text-sm">Adicionar Investimento</h3><div className="flex flex-col gap-3"><div className="flex gap-2"><select className="w-1/3 p-2 border rounded text-sm bg-gray-50" value={investmentForm.type} onChange={e => setInvestmentForm({...investmentForm, type: e.target.value})}><option>Poupança</option><option>CDB</option><option>Ações</option><option>Fundos</option><option>Outros</option></select><input type="text" placeholder="Nome" className="flex-1 p-2 border rounded text-sm" value={investmentForm.name} onChange={e => setInvestmentForm({...investmentForm, name: e.target.value})} /></div><div className="flex gap-2"><input type="number" placeholder="Valor (R$)" className="flex-1 p-2 border rounded text-sm" value={investmentForm.value} onChange={e => setInvestmentForm({...investmentForm, value: e.target.value})} /><button onClick={handleAddInvestment} className="w-24 bg-teal-600 text-white py-2 rounded font-bold hover:bg-teal-700">Salvar</button></div></div></div>
                                <div className="space-y-3">{userInvestments.map(inv => (<div key={inv.id} className="bg-white p-4 rounded-xl shadow border-l-4 border-teal-500 flex justify-between items-center"><div><span className="text-[10px] font-bold text-teal-600 bg-teal-50 px-2 py-0.5 rounded uppercase">{inv.type}</span><div className="font-bold text-gray-800 mt-1">{inv.name}</div></div><div className="flex items-center gap-3"><span className="font-bold text-teal-700">R$ {inv.value.toFixed(2)}</span><button onClick={() => deleteItem(inv.id, userInvestments, setUserInvestments)} className="text-gray-400 hover:text-red-500"><FinIconWrapper name="trash-2" size={16}/></button></div></div>))}</div>
                            </div>
                        )}

                        {view === 'assets' && (
                            <div className="space-y-6">
                                <div className="bg-blue-600 p-6 rounded-2xl shadow-lg text-white text-center"><div className="text-xs font-bold uppercase opacity-80 mb-1">Património Total</div><div className="text-3xl font-bold">R$ {userAssets.reduce((acc, curr) => acc + curr.value, 0).toFixed(2)}</div></div>
                                <div className="bg-white p-4 rounded-xl shadow"><h3 className="font-bold text-gray-700 mb-3 text-sm">Adicionar Bem</h3><div className="flex gap-2 mb-2"><input type="text" placeholder="Nome" className="flex-1 p-2 border rounded text-sm" value={assetForm.name} onChange={e => setAssetForm({...assetForm, name: e.target.value})} /><input type="number" placeholder="Valor" className="w-24 p-2 border rounded text-sm" value={assetForm.value} onChange={e => setAssetForm({...assetForm, value: e.target.value})} /></div><button onClick={handleAddAsset} className="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">Salvar Bem</button></div>
                                <div className="grid grid-cols-1 gap-3">{userAssets.map(asset => (<div key={asset.id} className="bg-white p-4 rounded-xl shadow flex justify-between items-center border-l-4 border-blue-500"><span className="font-bold text-gray-800">{asset.name}</span><div className="flex items-center gap-3"><span className="font-bold text-blue-600">R$ {asset.value.toFixed(2)}</span><button onClick={() => deleteItem(asset.id, userAssets, setUserAssets)} className="text-gray-400 hover:text-red-500"><FinIconWrapper name="trash-2" size={16}/></button></div></div>))}</div>
                            </div>
                        )}

                        {view === 'loans' && (
                            <div className="space-y-6">
                                <div className="bg-orange-500 p-6 rounded-2xl shadow-lg text-white text-center"><div className="text-xs font-bold uppercase opacity-80 mb-1">Total a Receber</div><div className="text-3xl font-bold">R$ {userLoans.reduce((acc, curr) => acc + curr.value, 0).toFixed(2)}</div></div>
                                <div className="bg-white p-4 rounded-xl shadow"><h3 className="font-bold text-gray-700 mb-3 text-sm">Registar Dívida</h3><input type="text" placeholder="Quem deve?" className="w-full p-2 border rounded text-sm mb-2" value={loanForm.name} onChange={e => setLoanForm({...loanForm, name: e.target.value})} /><div className="flex gap-2 mb-2"><input type="number" placeholder="Valor" className="flex-1 p-2 border rounded text-sm" value={loanForm.value} onChange={e => setLoanForm({...loanForm, value: e.target.value})} /><input type="date" className="w-32 p-2 border rounded text-sm" value={loanForm.date} onChange={e => setLoanForm({...loanForm, date: e.target.value})} /></div><input type="text" placeholder="Motivo" className="w-full p-2 border rounded text-sm mb-3" value={loanForm.desc} onChange={e => setLoanForm({...loanForm, desc: e.target.value})} /><button onClick={handleAddLoan} className="w-full bg-orange-500 text-white py-2 rounded font-bold hover:bg-orange-600">Adicionar</button></div>
                                <div className="space-y-3">{userLoans.map(loan => (<div key={loan.id} className="bg-white p-4 rounded-xl shadow border-l-4 border-orange-400"><div className="flex justify-between items-start mb-1"><h4 className="font-bold text-gray-800">{loan.name}</h4><span className="font-bold text-orange-600">R$ {loan.value.toFixed(2)}</span></div><p className="text-sm text-gray-600">{loan.desc}</p><div className="flex justify-between items-center mt-2 pt-2 border-t border-gray-100"><span className="text-xs text-gray-400">Previsto: {loan.date ? new Date(loan.date).toLocaleDateString('pt-BR') : 'Sem data'}</span><button onClick={() => deleteLoan(loan.id)} className="text-red-400 hover:text-red-600 text-xs font-bold flex items-center gap-1"><FinIconWrapper name="trash-2" size={12}/> Apagar</button></div></div>))}</div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        // --- DADOS PARA A FORCA ---
        const HANGMAN_CATEGORIES = {
            'FRUTAS': ['MELANCIA', 'ABACAXI', 'BANANA', 'MORANGO', 'LARANJA', 'UVA', 'MANGA', 'PERA', 'ABACATE', 'CUPUACU'],
            'ANIMAIS': ['CACHORRO', 'GIRAFA', 'ELEFANTE', 'LEAO', 'MACACO', 'TIGRE', 'ZEBRA', 'COELHO', 'GATO', 'ONCA'],
            'PAÍSES': ['BRASIL', 'ARGENTINA', 'CANADA', 'JAPAO', 'ITALIA', 'FRANÇA', 'EGITO', 'ESPANHA', 'CHINA'],
            'CARROS': ['FUSCA', 'GOL', 'PALIO', 'ONIX', 'COROLLA', 'CIVIC', 'MUSTANG', 'CAMARO', 'SAVEIRO'],
            'OBJETOS': ['CADEIRA', 'MESA', 'COMPUTADOR', 'TELEFONE', 'LIVRO', 'GARRAFA', 'JANELA', 'PORTA', 'SOFA', 'TACA']
        };

        // --- DADOS NAV ---
        const NAV_ITEMS = [
            { id: 'home', label: 'Início', icon: 'home' },
            { id: 'bible', label: 'Bíblia', icon: 'book-open' },
            { id: 'themes', label: 'Temas', icon: 'heart' },
            { id: 'share', label: 'Cartões', icon: 'image' },
            { id: 'names', label: 'Nomes', icon: 'user' },
            { id: 'finance', label: 'Financeiro', icon: 'dollar-sign' },
            { id: 'preaching', label: 'Pregação', icon: 'megaphone' },
            { id: 'games', label: 'Jogos', icon: 'gamepad-2' },
            { id: 'qrcode', label: 'QR Code', icon: 'qr-code' },
            { id: 'radio', label: 'Rádio', icon: 'radio' },
            { id: 'notes', label: 'Diário', icon: 'calendar' }
        ];

        // --- BANCO DE DADOS E DADOS ---
        const preachingDatabase = [
             {
                ref: "João 3:16",
                theme: "O Amor Incomparável",
                text: "Porque Deus amou o mundo de tal maneira que deu o seu Filho unigênito...",
                explanation: `📖 **Introdução**\nEste versículo é o coração do Evangelho. Ele revela a profundidade do amor de Deus por uma humanidade caída.\n\n1️⃣ **A Fonte do Amor:** "Porque Deus amou..." O amor não começa em nós, mas nEle. É Sua natureza.\n2️⃣ **A Dimensão do Amor:** "...de tal maneira..." Um amor sem medidas, sacrificial e incondicional.\n3️⃣ **A Ação do Amor:** "...que deu o seu Filho..." Amor não é só sentimento, é atitude. Deus deu o Seu melhor.\n4️⃣ **O Propósito:** "...para que todo aquele que nele crê não pereça..." A salvação está acessível a todos através da fé.\n\n🙌 **Conclusão**\nNão rejeite este amor. Ele já fez tudo por você. Receba a vida eterna hoje.`
            },
            {
                ref: "Salmos 23:1",
                theme: "O Pastor Suficiente",
                text: "O Senhor é o meu pastor, nada me faltará.",
                explanation: `📖 **Introdução**\nDavi, um pastor experiente, reconhece que ele mesmo é uma ovelha sob o cuidado do Grande Pastor.\n\n1️⃣ **Relacionamento Pessoal:** "O Senhor é o MEU pastor". Não é um Deus distante, mas alguém íntimo e pessoal.\n2️⃣ **Provisão Completa:** "Nada me faltará". Não significa luxo, mas que o essencial para a vida e a piedade será suprido.\n3️⃣ **Descanso e Direção:** O pastor leva a águas tranquilas e guia pelas veredas da justiça.\n\n🙌 **Conclusão**\nSe você está ansioso, lembre-se de quem é o seu Pastor. A ovelha não se preocupa, ela apenas segue a voz do dono.`
            },
            {
                ref: "Filipenses 4:13",
                theme: "A Verdadeira Força",
                text: "Tudo posso naquele que me fortalece.",
                explanation: `📖 **Introdução**\nEste texto foi escrito por Paulo na prisão! Não é sobre conquistar tudo o que queremos, mas sobre suportar tudo com Cristo.\n\n1️⃣ **O Contexto de Contentamento:** Paulo aprendeu a viver contente na fartura e na escassez.\n2️⃣ **A Fonte de Energia:** "Naquele". A força não vem de "dentro" (autoajuda), vem de Cristo.\n3️⃣ **A Capacidade:** "Tudo posso" significa que posso enfrentar qualquer circunstância sem perder a fé ou a alegria.\n\n🙌 **Conclusão**\nVocê não vai quebrar. A força de Cristo em você é maior que a pressão de fora.`
            }
        ];
        const bibleQuizDatabase = [
            { question: "Quem construiu a arca?", options: ["Moisés", "Noé", "Abraão", "Davi"], answer: 1 },
            { question: "Qual é o primeiro livro da Bíblia?", options: ["Mateus", "Apocalipse", "Gênesis", "Êxodo"], answer: 2 },
            { question: "Quem derrotou o gigante Golias?", options: ["Davi", "Saul", "Salomão", "Sansão"], answer: 0 },
            { question: "Onde Jesus nasceu?", options: ["Nazaré", "Jerusalém", "Belém", "Galileia"], answer: 2 },
            { question: "Quem foi engolido por um grande peixe?", options: ["Pedro", "Jonas", "Paulo", "João"], answer: 1 },
            { question: "Qual o nome da esposa de Abraão?", options: ["Raquel", "Rebeca", "Sara", "Lia"], answer: 2 },
            { question: "Quantos mandamentos Deus deu a Moisés?", options: ["5", "7", "10", "12"], answer: 2 },
            { question: "Quem traiu Jesus?", options: ["Pedro", "Judas Iscariotes", "Tiago", "Tomé"], answer: 1 },
            { question: "Quem abriu o Mar Vermelho?", options: ["Elias", "Moisés", "Josué", "Arão"], answer: 1 },
            { question: "Qual profeta foi levado ao céu numa carruagem de fogo?", options: ["Elias", "Eliseu", "Isaías", "Jeremias"], answer: 0 }
        ];
        
        // --- BASE DE DADOS DE VERSÍCULOS EXPANDIDA ---
        const verseDatabase = {
            motivacao: [
                { text: "Porque sou eu que conheço os planos que tenho para vós, diz o Senhor, planos de fazer-vos prosperar e não de causar dano, planos de dar-vos esperança e um futuro.", ref: "Jeremias 29:11" },
                { text: "Tudo posso naquele que me fortalece.", ref: "Filipenses 4:13" },
                { text: "Sede fortes e corajosos; não temais, nem vos atemorizeis diante deles; porque o Senhor vosso Deus é quem vai convosco. Não vos deixará, nem vos desamparará.", ref: "Deuteronômio 31:6" },
                { text: "Mas os que esperam no Senhor renovarão as forças, subirão com asas como águias; correrão, e não se cansarão; caminharão, e não se fatigarão.", ref: "Isaías 40:31" },
                { text: "Não fui eu que ordenei a você? Seja forte e corajoso! Não se apavore nem desanime, pois o Senhor, o seu Deus, estará com você por onde você andar.", ref: "Josué 1:9" },
                { text: "Entrega o teu caminho ao Senhor; confia nele, e ele o fará.", ref: "Salmos 37:5" },
                { text: "E Jesus, olhando para eles, disse-lhes: Aos homens é isso impossível, mas a Deus tudo é possível.", ref: "Mateus 19:26" },
                { text: "Mil cairão ao teu lado, e dez mil à tua direita, mas não chegará a ti.", ref: "Salmos 91:7" }
            ],
            financeiro: [
                { text: "O rico domina sobre os pobres e o que toma emprestado é servo do que empresta.", ref: "Provérbios 22:7" },
                { text: "Honra ao Senhor com os teus bens, e com a primeira parte de todos os teus ganhos.", ref: "Provérbios 3:9" },
                { text: "Pois qual de vós, querendo edificar uma torre, não se assenta primeiro a fazer as contas dos gastos?", ref: "Lucas 14:28" },
                { text: "O meu Deus suprirá todas as vossas necessidades segundo as suas riquezas na glória em Cristo Jesus.", ref: "Filipenses 4:19" }
            ],
            espiritual: [
                { text: "Vinde a mim, todos os que estais cansados e oprimidos, e eu vos aliviarei.", ref: "Mateus 11:28" },
                { text: "Verdadeiramente ele tomou sobre si as nossas enfermidades, e as nossas dores levou sobre si.", ref: "Isaías 53:4" },
                { text: "Sara os quebrantados de coração, e lhes ata as suas feridas.", ref: "Salmo 147:3" }
            ],
            familia: [
                { text: "Crê no Senhor Jesus e serás salvo, tu e a tua casa.", ref: "Atos 16:31" },
                { text: "Educa a criança no caminho em que deve andar; e até quando envelhecer não se desviará dele.", ref: "Provérbios 22:6" },
                { text: "Acima de tudo, porém, tende amor intenso uns para com os outros, porque o amor cobre uma multidão de pecados.", ref: "1 Pedro 4:8" }
            ]
        };
        
        const offlineBible = {
            "Gênesis": { 1: [{ number: 1, text: "No princípio criou Deus o céu e a terra." }] },
            "Salmos": { 23: [{ number: 1, text: "O SENHOR é o meu pastor, nada me faltará." }] }
        };
        const bibleBooks = ["Gênesis", "Êxodo", "Levítico", "Números", "Deuteronômio", "Josué", "Juízes", "Rute", "1 Samuel", "2 Samuel", "1 Reis", "2 Reis", "1 Crônicas", "2 Crônicas", "Esdras", "Neemias", "Ester", "Jó", "Salmos", "Provérbios", "Eclesiastes", "Cânticos", "Isaías", "Jeremias", "Lamentações", "Ezequiel", "Daniel", "Oseias", "Joel", "Amós", "Obadias", "Jonas", "Miqueias", "Naum", "Habacuque", "Sofonias", "Ageu", "Zacarias", "Malaquias", "Mateus", "Marcos", "Lucas", "João", "Atos", "Romanos", "1 Coríntios", "2 Coríntios", "Gálatas", "Efésios", "Filipenses", "Colossenses", "1 Tessalonicenses", "2 Tessalonicenses", "1 Timóteo", "2 Timóteo", "Tito", "Filemom", "Hebreus", "Tiago", "1 Pedro", "2 Pedro", "1 João", "2 João", "3 João", "Judas", "Apocalipse"];
        
        const nameDatabase = {
            "ana": "Cheia de graça e compaixão.", "maria": "Senhora soberana.", "joão": "Deus é cheio de graça.", "lucas": "O iluminado.", "pedro": "Rocha.",
            "paulo": "Pequeno.", "mateus": "Dádiva de Deus.", "marcos": "Guerreiro."
        };
        const cardBackgrounds = [
            { id: 1, type: 'image', url: 'https://images.unsplash.com/photo-1493246507139-91e8fad9978e?auto=format&fit=crop&w=800&q=80', thumb: 'Montanha' },
            { id: 2, type: 'image', url: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=800&q=80', thumb: 'Praia' },
            { id: 3, type: 'image', url: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=800&q=80', thumb: 'Céu' },
            { id: 5, type: 'gradient', gradient: 'linear-gradient(to right, #B8860B 0%, #FFD700 100%)', thumb: 'Ouro' },
            { id: 6, type: 'gradient', gradient: 'linear-gradient(135deg, #8B0000 0%, #DC143C 100%)', thumb: 'Sangue' },
            { id: 7, type: 'gradient', gradient: 'linear-gradient(120deg, #C0C0C0 0%, #E8E8E8 100%)', thumb: 'Prata' }
        ];

        // --- COMPONENTES AUXILIARES ---
        const ThemeCard = ({ title, iconName, category, color, onSelectVerse }) => {
            const [verse, setVerse] = useState(null);
            const generateVerse = () => {
                const list = verseDatabase[category];
                const random = list[Math.floor(Math.random() * list.length)];
                setVerse(random);
            };
            return (
                <div className={`bg-white rounded-xl shadow-lg overflow-hidden border-t-4 ${color} transition-all hover:shadow-xl`}>
                    <div className="p-6">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2"><IconWrapper name={iconName} className="text-gray-600" />{title}</h3>
                            <button onClick={generateVerse} className="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">Nova Palavra</button>
                        </div>
                        <div className="min-h-[120px] flex items-center justify-center bg-gray-50 rounded-lg p-4 relative">
                            {verse ? (
                                <div className="text-center animate-fadeIn">
                                    <p className="text-lg text-gray-700 italic mb-3">"{verse.text}"</p>
                                    <p className="text-sm font-bold text-gray-500 uppercase tracking-wider">{verse.ref}</p>
                                    <button onClick={() => onSelectVerse(verse)} className="mt-2 text-red-800 hover:text-red-900 text-sm font-bold flex items-center justify-center gap-1 mx-auto"><IconWrapper name="image" size={14} /> Criar Cartão</button>
                                </div>
                            ) : (
                                <p className="text-gray-400 text-sm text-center">Clique no botão para receber uma palavra.</p>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        function EvangelicalSystem() {
            const [activeTab, setActiveTab] = useState('home');
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [dailyVerse, setDailyVerse] = useState(null);
            
            // Estados Persistentes - DIÁRIO
            const [currentDate, setCurrentDate] = useState(new Date());
            const [diaryEntries, setDiaryEntries] = usePersistentState('userDiaryEntries', {});

            // Estados Persistentes - BÍBLIA (HIGHLIGHTS)
            const [highlights, setHighlights] = usePersistentState('bibleHighlights', {});
            const [activeHighlightColor, setActiveHighlightColor] = useState('#fef08a'); // Cor padrão (Amarelo)

            // ESTADOS JOGOS
            const [gameMode, setGameMode] = useState('menu'); // 'menu', 'quiz', 'memory', 'hangman'

            // --- QUIZ STATES ---
            const [currentQuizQuestions, setCurrentQuizQuestions] = useState([]);
            const [quizIndex, setQuizIndex] = useState(0);
            const [quizScore, setQuizScore] = useState(0);
            const [showQuizScore, setShowQuizScore] = useState(false);
            const [quizActive, setQuizActive] = useState(false);
            const [quizTimer, setQuizTimer] = useState(600);
            const [quizGameOver, setQuizGameOver] = useState(false);
            const [questionsAnsweredCount, setQuestionsAnsweredCount] = useState(0);

            // --- MEMORY GAME STATES ---
            const [memoryCards, setMemoryCards] = useState([]);
            const [memoryFlipped, setMemoryFlipped] = useState([]);
            const [memoryMatched, setMemoryMatched] = useState([]);
            const [memoryMoves, setMemoryMoves] = useState(0);
            const [memoryLock, setMemoryLock] = useState(false);
            const [memoryWin, setMemoryWin] = useState(false);

            // --- HANGMAN (FORCA) STATES ---
            const [hangmanWord, setHangmanWord] = useState('');
            const [hangmanCategory, setHangmanCategory] = useState('');
            const [hangmanGuessed, setHangmanGuessed] = useState([]);
            const [hangmanWrong, setHangmanWrong] = useState([]);
            const [hangmanTimer, setHangmanTimer] = useState(120);
            const [hangmanActive, setHangmanActive] = useState(false);
            const [hangmanStatus, setHangmanStatus] = useState('playing'); // playing, won, lost

            // --- RADIO STATES ---
            const [isPlayingRadio, setIsPlayingRadio] = useState(false);
            const audioRef = useRef(null);

            // Outros Estados
            const [chapterContent, setChapterContent] = useState(null);
            const [loadingBible, setLoadingBible] = useState(false);
            const [bibleError, setBibleError] = useState(false);
            const [fontSize, setFontSize] = useState(18);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const isSpeakingRef = useRef(false); // Ref para evitar problema de closure
            const [voices, setVoices] = useState([]);
            const [selectedVoiceIndex, setSelectedVoiceIndex] = useState(0);
            const [selectedBg, setSelectedBg] = useState(cardBackgrounds[0]);
            const [nameResult, setNameResult] = useState(null);
            const [sermon, setSermon] = useState(null);
            const [showToast, setShowToast] = useState(false);
            const [imageSearchQuery, setImageSearchQuery] = useState("");
            const [searchingImage, setSearchingImage] = useState(false);
            const [bgList, setBgList] = useState(cardBackgrounds);
            const [customImageUrl, setCustomImageUrl] = useState(""); 
            const [showBibleNav, setShowBibleNav] = useState(false);
            const [textPos, setTextPos] = usePersistentState('cardTextPos', { x: 400, y: 300 });
            const [textColor, setTextColor] = useState("#ffffff");
            const [isDragging, setIsDragging] = useState(false);
            
            // Estados Persistentes - Configurações
            const [cardText, setCardText] = usePersistentState('userCardText', '');
            const [inputName, setInputName] = usePersistentState('userInputName', '');
            const [qrUrl, setQrUrl] = usePersistentState('qrUrl', '');
            const [qrWifiSsid, setQrWifiSsid] = usePersistentState('qrWifiSsid', '');
            const [qrWifiPass, setQrWifiPass] = usePersistentState('qrWifiPass', '');
            const [qrPixKey, setQrPixKey] = usePersistentState('qrPixKey', '');
            const [qrPixName, setQrPixName] = usePersistentState('qrPixName', '');
            const [qrPixCity, setQrPixCity] = usePersistentState('qrPixCity', '');
            const [qrPixAmount, setQrPixAmount] = usePersistentState('qrPixAmount', '');
            const [selectedBook, setSelectedBook] = usePersistentState('lastBibleBook', 'Gênesis');
            const [selectedChapter, setSelectedChapter] = usePersistentState('lastBibleChapter', 1);

            const canvasRef = useRef(null);
            const qrCodeRef = useRef(null);
            const qrInstance = useRef(null);
            const speechRef = useRef(null); // Ref for speech synthesis to prevent GC

            // Helpers for Diary
            const getCurrentDateKey = () => formatDateKey(currentDate);
            const getCurrentEntry = () => diaryEntries[getCurrentDateKey()] || "";
            const handleDiaryChange = (e) => { const val = e.target.value; setDiaryEntries(prev => ({ ...prev, [getCurrentDateKey()]: val })); };
            const changeDay = (days) => { const newDate = new Date(currentDate); newDate.setDate(newDate.getDate() + days); setCurrentDate(newDate); };
            const goToToday = () => setCurrentDate(new Date());

            // --- LÓGICA RADIO ---
            const toggleRadio = () => {
                if (!audioRef.current) return;
                if (isPlayingRadio) { audioRef.current.pause(); } 
                else { 
                    const playPromise = audioRef.current.play();
                    if (playPromise !== undefined) { playPromise.catch(error => { console.error("Erro ao tocar:", error); alert("Não foi possível reproduzir automaticamente. Verifique se o navegador permite áudio."); }); }
                }
                setIsPlayingRadio(!isPlayingRadio);
            };

            // --- LÓGICA DO JOGO DA MEMÓRIA ---
            const memoryEmojis = ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼'];
            const startMemoryGame = () => {
                Tone.start();
                const shuffled = [...memoryEmojis, ...memoryEmojis].sort(() => Math.random() - 0.5).map((emoji, index) => ({ id: index, emoji, isFlipped: false, isMatched: false }));
                setMemoryCards(shuffled); setMemoryFlipped([]); setMemoryMatched([]); setMemoryMoves(0); setMemoryLock(false); setMemoryWin(false); setGameMode('memory');
            };
            const handleMemoryCardClick = (card) => {
                if (memoryLock || card.isFlipped || card.isMatched) return;
                const note = ['C4','D4','E4','F4','G4','A4','B4','C5'][memoryEmojis.indexOf(card.emoji)];
                try { const synth = new Tone.Synth().toDestination(); synth.triggerAttackRelease(note, "8n"); } catch(e){}
                const newCards = memoryCards.map(c => c.id === card.id ? { ...c, isFlipped: true } : c);
                setMemoryCards(newCards);
                const newFlipped = [...memoryFlipped, card];
                setMemoryFlipped(newFlipped);
                if (newFlipped.length === 2) {
                    setMemoryLock(true); setMemoryMoves(m => m + 1);
                    if (newFlipped[0].emoji === newFlipped[1].emoji) {
                        setMemoryCards(prev => prev.map(c => (c.id === newFlipped[0].id || c.id === newFlipped[1].id) ? { ...c, isMatched: true } : c));
                        setMemoryMatched(prev => [...prev, newFlipped[0].id, newFlipped[1].id]);
                        setMemoryFlipped([]); setMemoryLock(false);
                        try { const p = new Tone.PolySynth().toDestination(); p.triggerAttackRelease(['C4','E4','G4'], '8n'); } catch(e){}
                        if (newCards.filter(c => !c.isMatched).length === 2) { setTimeout(() => setMemoryWin(true), 500); }
                    } else {
                        try { const f = new Tone.MembraneSynth().toDestination(); f.triggerAttackRelease('C2', '8n'); } catch(e){}
                        setTimeout(() => { setMemoryCards(prev => prev.map(c => (c.id === newFlipped[0].id || c.id === newFlipped[1].id) ? { ...c, isFlipped: false } : c)); setMemoryFlipped([]); setMemoryLock(false); }, 1000);
                    }
                }
            };

            // --- LÓGICA DO JOGO DA FORCA ---
            const startHangmanGame = () => {
                Tone.start();
                const categories = Object.keys(HANGMAN_CATEGORIES);
                const randomCat = categories[Math.floor(Math.random() * categories.length)];
                const wordList = HANGMAN_CATEGORIES[randomCat];
                const randomWord = wordList[Math.floor(Math.random() * wordList.length)];
                setHangmanCategory(randomCat); setHangmanWord(randomWord); setHangmanGuessed([]); setHangmanWrong([]); setHangmanTimer(120); setHangmanStatus('playing'); setHangmanActive(true); setGameMode('hangman');
            };

            const handleHangmanGuess = (letter) => {
                if (hangmanStatus !== 'playing') return;
                setHangmanTimer(120);
                if (hangmanWord.includes(letter)) {
                    playSoundEffect('hangman_correct'); setHangmanGuessed(prev => [...prev, letter]);
                    const uniqueChars = [...new Set(hangmanWord.split(''))];
                    const allGuessed = uniqueChars.every(char => [...hangmanGuessed, letter].includes(char));
                    if (allGuessed) { setHangmanStatus('won'); setHangmanActive(false); playSoundEffect('hangman_win'); }
                } else {
                    playSoundEffect('hangman_wrong'); setHangmanWrong(prev => [...prev, letter]);
                    if (hangmanWrong.length + 1 >= 6) { setHangmanStatus('lost'); setHangmanActive(false); playSoundEffect('hangman_lose'); }
                }
            };

            useEffect(() => {
                let interval;
                if (hangmanActive && hangmanTimer > 0) { interval = setInterval(() => { setHangmanTimer(prev => { if (prev <= 1) { setHangmanActive(false); setHangmanStatus('lost'); playSoundEffect('hangman_lose'); return 0; } return prev - 1; }); }, 1000); }
                return () => clearInterval(interval);
            }, [hangmanActive, hangmanTimer]);

            // --- LÓGICA DO QUIZ ---
            useEffect(() => {
                let interval;
                if (quizActive && quizTimer > 0) { interval = setInterval(() => setQuizTimer(p => p - 1), 1000); } 
                else if (quizTimer === 0 && quizActive) { setQuizActive(false); setQuizGameOver(true); playSoundEffect('quiz_wrong'); }
                return () => clearInterval(interval);
            }, [quizActive, quizTimer]);

            const startQuiz = () => {
                Tone.start();
                const shuffled = [...bibleQuizDatabase].sort(() => 0.5 - Math.random());
                setCurrentQuizQuestions(shuffled.slice(0, 10));
                setQuizIndex(0); setQuizScore(0); setQuestionsAnsweredCount(0); setQuizTimer(600); setQuizActive(true); setShowQuizScore(false); setQuizGameOver(false); setGameMode('quiz');
            };

            const handleQuizAnswer = (optionIndex) => {
                const isCorrect = optionIndex === currentQuizQuestions[quizIndex].answer;
                if (isCorrect) { setQuizScore(s => s + 10); playSoundEffect('quiz_correct'); } else { playSoundEffect('quiz_wrong'); }
                const nextCount = questionsAnsweredCount + 1;
                setQuestionsAnsweredCount(nextCount);
                if (nextCount >= 10) { setQuizActive(false); setShowQuizScore(true); playSoundEffect(quizScore >= 70 ? 'quiz_win' : 'quiz_wrong'); } 
                else { setQuizIndex(i => i + 1); }
            };

            const formatTime = (seconds) => { const mins = Math.floor(seconds / 60); const secs = seconds % 60; return `${mins}:${secs < 10 ? '0' : ''}${secs}`; };

            // Init Effects
            useEffect(() => {
                const randomVerse = verseDatabase.motivacao[0];
                setDailyVerse(randomVerse);
                if (!cardText) setCardText(randomVerse.text);
                fetchChapter(selectedBook, selectedChapter);
                const loadVoices = () => { 
                    if ('speechSynthesis' in window) { 
                        const available = window.speechSynthesis.getVoices(); 
                        setVoices(available); 
                        const ptVoices = available.filter(v => v.lang.includes('pt'));
                        const preferredNames = ["Daniel", "Felipe", "Ricardo", "Joaquim", "Microsoft", "Google"];
                        let bestVoice = ptVoices[0]; 
                        for (const name of preferredNames) { const found = ptVoices.find(v => v.name.includes(name)); if (found) { bestVoice = found; break; } }
                        if (bestVoice) { const index = available.indexOf(bestVoice); setSelectedVoiceIndex(index !== -1 ? index : 0); }
                    } 
                };
                if ('speechSynthesis' in window) { loadVoices(); window.speechSynthesis.onvoiceschanged = loadVoices; }
                if (inputName) analyzeNames();
            }, []);

            useEffect(() => { if (activeTab === 'share') drawCard(); }, [activeTab, cardText, selectedBg, textPos, textColor]);

            const BackButton = () => (
                <button onClick={() => setActiveTab('home')} className="mb-4 flex items-center gap-2 text-red-800 hover:text-red-900 font-bold transition-colors">
                    <div className="p-1 bg-red-100 rounded-full"><IconWrapper name="arrow-left" size={20} /></div>
                    Voltar ao Início
                </button>
            );

            const normalizeBookName = (name) => name.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

            const fetchChapter = async (book, chapter) => {
                setLoadingBible(true); setBibleError(false);
                try {
                    const safeBook = encodeURIComponent(normalizeBookName(book));
                    const response = await fetch(`https://bible-api.com/${safeBook}+${chapter}?translation=almeida`);
                    if (!response.ok) throw new Error("Erro");
                    const data = await response.json();
                    if (!data.verses) throw new Error("Dados inválidos");
                    setChapterContent({ book: { name: book }, chapter: { number: chapter }, verses: data.verses.map(v => ({ number: v.verse, text: v.text.trim() })) });
                } catch (error) {
                    if (offlineBible[book] && offlineBible[book][chapter]) { setChapterContent({ book: { name: book }, chapter: { number: chapter }, verses: offlineBible[book][chapter] }); } 
                    else { setBibleError(true); setChapterContent({ book: { name: book }, chapter: { number: chapter }, verses: [{ number: 1, text: "Modo Offline. Verifique a internet." }] }); }
                } finally { setLoadingBible(false); }
            };

            const toggleNarrator = () => {
                if (!('speechSynthesis' in window)) return;
                if (isSpeaking) { window.speechSynthesis.cancel(); setIsSpeaking(false); isSpeakingRef.current = false; } else {
                    if (!chapterContent || !chapterContent.verses) return;
                    setIsSpeaking(true); isSpeakingRef.current = true;
                    let currentVerseIndex = 0;
                    const speakNextVerse = () => {
                        if (!isSpeakingRef.current) return; 
                        if (currentVerseIndex >= chapterContent.verses.length) { setIsSpeaking(false); isSpeakingRef.current = false; return; }
                        const verse = chapterContent.verses[currentVerseIndex];
                        const utterance = new SpeechSynthesisUtterance(`${verse.text}`);
                        if (voices[selectedVoiceIndex]) { utterance.voice = voices[selectedVoiceIndex]; }
                        utterance.onend = () => { currentVerseIndex++; speakNextVerse(); };
                        utterance.onerror = (e) => { console.error("Erro na fala", e); setIsSpeaking(false); isSpeakingRef.current = false; };
                        speechRef.current = utterance;
                        window.speechSynthesis.speak(utterance);
                    };
                    window.speechSynthesis.cancel(); speakNextVerse();
                }
            };

            const highlightColors = [
                { color: '#fef08a', name: 'Amarelo', class: 'bg-yellow-200' }, { color: '#bbf7d0', name: 'Verde', class: 'bg-green-200' }, { color: '#bfdbfe', name: 'Azul', class: 'bg-blue-200' },
                { color: '#fbcfe8', name: 'Rosa', class: 'bg-pink-200' }, { color: '#e9d5ff', name: 'Roxo', class: 'bg-purple-200' },
            ];

            const handleVerseMouseUp = (verseNum) => {
                const selection = window.getSelection();
                if (!chapterContent) return;
                const bookName = chapterContent.book.name;
                const chapterNum = chapterContent.chapter.number;
                const key = `${bookName}-${chapterNum}-${verseNum}`;
                setHighlights(prev => { const newHighlights = { ...prev }; if (newHighlights[key] === activeHighlightColor) { delete newHighlights[key]; } else { newHighlights[key] = activeHighlightColor; } return newHighlights; });
                if (selection) selection.removeAllRanges();
            };

            const getVerseHighlightStyle = (verseNum) => {
                if (!chapterContent) return {};
                const bookName = chapterContent.book.name;
                const chapterNum = chapterContent.chapter.number;
                const key = `${bookName}-${chapterNum}-${verseNum}`;
                const color = highlights[key];
                if (!color) return {};
                return { backgroundColor: color, paddingLeft: '8px', borderLeft: '4px solid rgba(0,0,0,0.1)' };
            };

            const analyzeNames = () => {
                if (!inputName.trim()) return;
                const names = inputName.trim().split(/\s+/);
                const foundResults = [];
                names.forEach(n => {
                    const cleanName = n.toLowerCase().replace(/[0-9]/g, '');
                    const foundKey = Object.keys(nameDatabase).find(key => key === cleanName || key.normalize("NFD").replace(/[\u0300-\u036f]/g, "") === cleanName.normalize("NFD").replace(/[\u0300-\u036f]/g, ""));
                    if (foundKey) { foundResults.push({ name: n.charAt(0).toUpperCase() + n.slice(1), meaning: nameDatabase[foundKey], found: true }); }
                });
                if (foundResults.length > 0) { setNameResult(foundResults); } 
                else { setNameResult([{ name: inputName, meaning: `Filho(a) amado(a) de Deus! O Senhor tem um propósito especial para ${inputName}, que é ser luz onde estiver.`, found: false }]); }
            };

            const saveNote = () => { setShowToast(true); setTimeout(() => setShowToast(false), 3000); };

            const handleSearchImage = async () => {
                if (!imageSearchQuery) { alert("Por favor, digite algo para pesquisar."); return; }
                setSearchingImage(true);
                try { const directUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(imageSearchQuery)}%20realistic%20high%20quality%204k%20photography?nologo=true&width=800&height=600&seed=${Date.now()}`; const finalImage = { id: Date.now(), type: 'image', url: directUrl, thumb: imageSearchQuery }; setBgList([finalImage, ...bgList]); setSelectedBg(finalImage); } catch (e) { alert("Erro ao buscar imagem"); } finally { setSearchingImage(false); }
            };

            const handleCustomImage = () => { if(!customImageUrl) { alert("Cole o link da imagem primeiro."); return; } const newBg = { id: Date.now(), type: 'image', url: customImageUrl, thumb: 'Link' }; setBgList([newBg, ...bgList]); setSelectedBg(newBg); };
            const handleFileUpload = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (evt) => { const newBg = { id: 'upload', type: 'image', url: evt.target.result, thumb: 'Upload' }; setBgList([newBg, ...bgList]); setSelectedBg(newBg); }; reader.readAsDataURL(file); } };

            const handleMouseDown = () => setIsDragging(true);
            const handleMouseUp = () => setIsDragging(false);
            const handleMouseMove = (e) => { if (!isDragging || !canvasRef.current) return; const canvas = canvasRef.current; const rect = canvas.getBoundingClientRect(); const scaleX = canvas.width / rect.width; const scaleY = canvas.height / rect.height; const x = (e.clientX - rect.left) * scaleX; const y = (e.clientY - rect.top) * scaleY; setTextPos({ x, y }); };
            const handleTouchMove = (e) => { if (!isDragging || !canvasRef.current) return; e.preventDefault(); const canvas = canvasRef.current; const rect = canvas.getBoundingClientRect(); const scaleX = canvas.width / rect.width; const scaleY = canvas.height / rect.height; const touch = e.touches[0]; const x = (touch.clientX - rect.left) * scaleX; const y = (touch.clientY - rect.top) * scaleY; setTextPos({ x, y }); };

            const drawCard = () => {
                const canvas = canvasRef.current; if (!canvas) return;
                const ctx = canvas.getContext('2d'); canvas.width = 800; canvas.height = 600;
                const renderText = () => { ctx.fillStyle = "rgba(0,0,0,0.4)"; ctx.fillRect(0,0,800,600); ctx.font = "bold 32px serif"; ctx.fillStyle = textColor; ctx.textAlign = "center"; const words = cardText.split(' '); let line = ''; const lineHeight = 40; const lines = []; for(let n = 0; n < words.length; n++) { let testLine = line + words[n] + ' '; let metrics = ctx.measureText(testLine); if (metrics.width > 700 && n > 0) { lines.push(line); line = words[n] + ' '; } else { line = testLine; } } lines.push(line); const totalHeight = lines.length * lineHeight; let y = textPos.y - (totalHeight / 2) + (lineHeight / 2); lines.forEach(l => { ctx.fillText(l, textPos.x, y); y += lineHeight; }); };
                if (selectedBg.type === 'image') { const img = new Image(); img.crossOrigin = "anonymous"; img.src = selectedBg.url; img.onload = () => { ctx.drawImage(img,0,0,800,600); renderText(); }; img.onerror = () => { ctx.fillStyle = "#333"; ctx.fillRect(0,0,800,600); renderText(); }; } 
                else { const grd = ctx.createLinearGradient(0, 0, 800, 600); if (selectedBg.id === 5) { grd.addColorStop(0, "#B8860B"); grd.addColorStop(1, "#FFD700"); } else if (selectedBg.id === 6) { grd.addColorStop(0, "#8B0000"); grd.addColorStop(1, "#DC143C"); } else { grd.addColorStop(0, "#C0C0C0"); grd.addColorStop(1, "#E8E8E8"); } ctx.fillStyle = grd; ctx.fillRect(0,0,800,600); renderText(); }
            };

            const downloadCard = () => { const canvas = canvasRef.current; if (!canvas) return; const link = document.createElement('a'); link.download = 'cartao.png'; link.href = canvas.toDataURL(); link.click(); };
            const shareCard = async () => { const canvas = canvasRef.current; if (!canvas) return; canvas.toBlob(async (blob) => { const file = new File([blob], "cartao_sistema_vida.png", { type: "image/png" }); if (navigator.share) { try { await navigator.share({ files: [file], title: 'Sistema Vida', text: cardText }); } catch (error) { console.log('Erro partilha:', error); } } else { alert("Partilha direta não suportada. Baixe a imagem primeiro."); } }); };

            const gerarQRCodeVisual = (texto) => { if (!qrCodeRef.current) return;
                qrCodeRef.current.innerHTML = '';
                new QRCode(qrCodeRef.current, { text: texto, width: 256, height: 256, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H });
            };
            
            const handleGerarUrl = () => { if(qrUrl) gerarQRCodeVisual(qrUrl); else alert("Digite uma URL."); };
            const handleGerarWifi = () => { if(qrWifiSsid) gerarQRCodeVisual(`WIFI:T:WPA;S:${qrWifiSsid};P:${qrWifiPass};;`); else alert("SSID é obrigatório."); };
            const handleGerarPix = () => { if (!qrPixKey || !qrPixName || !qrPixCity) { alert("Chave, Nome e Cidade são obrigatórios."); return; } const merchantAccountInfo = [formatarEMV('00', 'br.gov.bcb.pix'), formatarEMV('01', qrPixKey)].join(''); let brCode = [formatarEMV('00', '01'), formatarEMV('26', merchantAccountInfo), formatarEMV('52', '0000'), formatarEMV('53', '986')]; if (qrPixAmount) { const valor = parseFloat(qrPixAmount.replace(",", ".")).toFixed(2); brCode.push(formatarEMV('54', valor)); } brCode.push(formatarEMV('58', 'BR')); brCode.push(formatarEMV('59', simplificarTexto(qrPixName).substring(0, 25))); brCode.push(formatarEMV('60', simplificarTexto(qrPixCity).substring(0, 15))); brCode.push(formatarEMV('62', formatarEMV('05', '***'))); brCode.push('6304'); const stringPIX = brCode.join(''); const brCodeCompleto = stringPIX + crc16(stringPIX); gerarQRCodeVisual(brCodeCompleto); };
            const downloadQRCode = () => { if (!qrCodeRef.current) return; const img = qrCodeRef.current.querySelector('img'); if (img) { const link = document.createElement('a'); link.href = img.src; link.download = 'qrcode.png'; link.click(); } };

            return (
                <div className="min-h-screen flex flex-col font-sans">
                    {showToast && (
                        <div className="fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-2xl z-[100] animate-fadeIn flex items-center gap-2 no-print">
                            <IconWrapper name="check-circle" size={20} /><div><p className="font-bold">Salvo!</p><p className="text-sm">Dados guardados.</p></div>
                        </div>
                    )}
                    
                    <div style={{display: 'none'}}>
                        <audio ref={audioRef} src="https://live.hunter.fm/gospel_stream?ag=mp3" crossOrigin="anonymous" onPlay={() => setIsPlayingRadio(true)} onPause={() => setIsPlayingRadio(false)} onError={() => { console.log("Erro no stream de áudio"); setIsPlayingRadio(false); }}></audio>
                    </div>

                    <header className="bg-red-800 text-white shadow-lg sticky top-0 z-50 no-print">
                        <div className="container mx-auto px-4 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-3 cursor-pointer" onClick={() => setActiveTab('home')}>
                                <IconWrapper name="book-open" className="text-yellow-400" size={32} /><div><h1 className="text-2xl font-bold text-white">Sistema Vida</h1><p className="text-xs text-gray-200">Alimento Diário</p></div>
                            </div>
                            <nav className="hidden xl:flex gap-4 text-sm font-medium overflow-x-auto">
                                {NAV_ITEMS.map(item => (
                                    <button key={item.id} onClick={() => setActiveTab(item.id)} className={`hover:text-yellow-300 whitespace-nowrap transition-colors duration-200 ${activeTab === item.id ? 'text-yellow-400 font-bold' : ''}`}>{item.label}</button>
                                ))}
                            </nav>
                            <button className="xl:hidden" onClick={() => setMobileMenuOpen(!mobileMenuOpen)}><IconWrapper name="menu" /></button>
                        </div>
                        {mobileMenuOpen && (
                            <div className="xl:hidden bg-red-900 p-4 grid grid-cols-2 gap-2">
                                {NAV_ITEMS.map(item => (
                                    <button key={item.id} onClick={() => {setActiveTab(item.id); setMobileMenuOpen(false)}} className={`text-left p-2 rounded transition-colors ${activeTab === item.id ? 'bg-red-800 font-bold' : 'hover:bg-red-800'}`}>
                                        <div className="flex items-center gap-2"><IconWrapper name={item.icon} size={16} />{item.label}</div>
                                    </button>
                                ))}
                            </div>
                        )}
                    </header>
                    <main className="flex-grow container mx-auto px-4 py-8">
                        {/* --- CONTEÚDO ABAS --- */}
                        {activeTab === 'home' && (
                            <div className="space-y-8 animate-fadeIn">
                                <div className="bg-gradient-to-r from-red-800 to-red-600 rounded-2xl shadow-xl p-8 text-white text-center">
                                    <h2 className="text-2xl font-serif mb-4">"{dailyVerse?.text}"</h2>
                                    <button onClick={() => setActiveTab('bible')} className="bg-white text-red-800 px-6 py-2 rounded-full font-bold shadow hover:bg-gray-100 flex items-center justify-center gap-2 mx-auto"><IconWrapper name="book-open" size={18}/> Ler a Bíblia</button>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    {NAV_ITEMS.filter(i => i.id !== 'home').map(i => (
                                        <div key={i.id} onClick={()=>setActiveTab(i.id)} className="bg-white p-6 rounded-xl shadow text-center cursor-pointer hover:shadow-md transition-transform hover:scale-105">
                                            <div className={`w-12 h-12 mx-auto rounded-full flex items-center justify-center bg-red-100 text-red-800 mb-2`}><IconWrapper name={i.icon} /></div><h3 className="font-bold text-gray-700">{i.label}</h3>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        {/* --- BÍBLIA --- */}
                        {activeTab === 'bible' && (
                            <div className="bg-white rounded-xl shadow-lg flex flex-col md:flex-row overflow-hidden animate-fadeIn h-[80vh] relative">
                                <div className="md:hidden p-4 bg-red-50 border-b flex justify-between items-center">
                                    <BackButton />
                                    <button onClick={() => setShowBibleNav(!showBibleNav)} className="px-4 py-2 bg-red-800 text-white rounded text-sm font-bold">
                                        {showBibleNav ? 'Ler Texto' : `${selectedBook} ${selectedChapter} ▾`}
                                    </button>
                                </div>
                                <div className={`w-full md:w-64 bg-gray-50 border-r p-4 overflow-y-auto transition-all duration-300 ease-in-out ${showBibleNav ? 'block' : 'hidden'} md:block`}>
                                    <div className="hidden md:block"><BackButton /></div>
                                    <select value={selectedBook} onChange={(e) => { const newBook = e.target.value; setSelectedBook(newBook); setSelectedChapter(1); fetchChapter(newBook, 1); }} className="w-full p-2 mb-4 border rounded text-gray-800">{bibleBooks.map(b => <option key={b} value={b}>{b}</option>)}</select>
                                    <div className="grid grid-cols-5 gap-1">{[...Array(50)].map((_, i) => (<button key={i} onClick={() => { setSelectedChapter(i+1); fetchChapter(selectedBook, i+1); setShowBibleNav(false); }} className={`p-1 text-xs rounded ${selectedChapter===i+1?'bg-yellow-500 text-white':'bg-gray-200 text-gray-700'}`}>{i+1}</button>))}</div>
                                    <div className="mt-4 pt-4 border-t"><label className="text-xs font-bold text-gray-500">VOZ</label><select className="w-full p-2 border rounded text-xs text-gray-800" onChange={(e)=>setSelectedVoiceIndex(e.target.value)}>{voices.map((v,k)=><option key={k} value={k}>{v.name.slice(0,20)}</option>)}</select></div>
                                </div>
                                <div className={`flex-1 p-8 overflow-y-auto relative bible-content-area ${showBibleNav ? 'hidden md:block' : 'block'}`}>
                                    {loadingBible ? <div className="text-center mt-20 text-gray-500">Carregando...</div> : chapterContent && (
                                        <>
                                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4 gap-4">
                                                <h2 className="text-3xl font-serif font-bold text-red-900">{chapterContent.book.name} {chapterContent.chapter.number}</h2>
                                                <div className="flex flex-col items-end gap-2">
                                                    <div className="flex items-center gap-2 bg-gray-100 p-2 rounded-lg"><span className="text-xs font-bold text-gray-500">Marcador:</span>{highlightColors.map((c) => (<button key={c.color} onClick={() => setActiveHighlightColor(c.color)} className={`w-6 h-6 rounded-full border-2 transition-transform hover:scale-110 ${activeHighlightColor === c.color ? 'border-gray-600 scale-110 shadow-sm' : 'border-transparent'}`} style={{ backgroundColor: c.color }} title={c.name} />))}</div>
                                                    <button onClick={toggleNarrator} className={`p-2 rounded-full flex items-center gap-2 text-sm font-bold transition-colors ${isSpeaking?'bg-red-100 text-red-600':'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}><IconWrapper name={isSpeaking?'square':'volume-2'} size={16}/> {isSpeaking ? 'Parar Leitura' : 'Ouvir Capítulo'}</button>
                                                </div>
                                            </div>
                                            <div className="space-y-4 font-serif text-gray-800" style={{fontSize: fontSize}}>
                                                {chapterContent.verses?.map(v => (<p key={v.number} onMouseUp={() => handleVerseMouseUp(v.number)} style={getVerseHighlightStyle(v.number)} className="p-1 rounded transition-all duration-300 cursor-text hover:bg-gray-50 leading-relaxed" title="Selecione ou clique para marcar/desmarcar"><span className="text-yellow-600 font-bold text-xs mr-2 select-none align-top">{v.number}</span>{v.text}</p>))}
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        )}
                        {/* --- TEMAS --- */}
                        {activeTab === 'themes' && (
                            <div className="grid md:grid-cols-2 gap-6 animate-fadeIn">
                                <div className="col-span-full"><BackButton /></div>
                                <ThemeCard title="Financeiro & Prosperidade" iconName="dollar-sign" category="financeiro" color="border-yellow-500" onSelectVerse={(v) => { setCardText(`${v.text} - ${v.ref}`); setActiveTab('share'); }} />
                                <ThemeCard title="Cura & Conforto" iconName="activity" category="espiritual" color="border-red-600" onSelectVerse={(v) => { setCardText(`${v.text} - ${v.ref}`); setActiveTab('share'); }} />
                                <ThemeCard title="Motivação & Fé" iconName="sun" category="motivacao" color="border-yellow-400" onSelectVerse={(v) => { setCardText(`${v.text} - ${v.ref}`); setActiveTab('share'); }} />
                                <ThemeCard title="Família & Lar" iconName="heart" category="familia" color="border-red-400" onSelectVerse={(v) => { setCardText(`${v.text} - ${v.ref}`); setActiveTab('share'); }} />
                            </div>
                        )}
                        {/* --- SHARE/CARTÕES --- */}
                        {activeTab === 'share' && (
                            <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 animate-fadeIn">
                                <BackButton /><h2 className="text-2xl font-bold mb-6 flex items-center gap-2 text-red-800"><IconWrapper name="image" className="text-yellow-500"/> Criador de Cartões</h2>
                                <div className="grid md:grid-cols-2 gap-8">
                                    <div className="space-y-4">
                                        <textarea value={cardText} onChange={(e)=>setCardText(e.target.value)} className="w-full p-3 border rounded h-32 text-gray-800" placeholder="Mensagem..."></textarea>
                                        <div className="flex items-center gap-3 mb-2"><span className="text-sm font-bold text-gray-600">Cor do Texto:</span>{["#ffffff", "#000000", "#228B22", "#FFD700", "#C0C0C0", "#FF69B4", "#0000FF", "#FF0000", "#9370DB"].map(color => (<button key={color} onClick={() => setTextColor(color)} className={`w-6 h-6 rounded-full border ${textColor === color ? "ring-2 ring-offset-2 ring-gray-400" : ""}`} style={{backgroundColor: color}} title={color}></button>))}</div>
                                        <div className="flex gap-2 flex-wrap"><input type="text" value={imageSearchQuery} onChange={(e)=>setImageSearchQuery(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleSearchImage()} placeholder="Buscar imagem (ex: Cruz)..." className="flex-1 p-2 border rounded text-sm text-gray-800" /><div className="w-full flex gap-2 mt-1"><input type="text" value={customImageUrl} onChange={(e)=>setCustomImageUrl(e.target.value)} placeholder="Ou cole um link aqui..." className="flex-1 p-2 border rounded text-sm text-gray-800" /><button onClick={handleCustomImage} className="bg-yellow-500 text-white px-4 py-2 rounded text-sm hover:bg-yellow-600 transition-colors flex items-center gap-2" title="Usar Link"><IconWrapper name="link" size={16}/> Usar</button></div><button onClick={handleSearchImage} disabled={searchingImage} className="bg-red-700 text-white px-4 py-2 rounded text-sm hover:bg-red-800 transition-colors flex-1" title="Buscar Imagem">{searchingImage ? '...' : <><IconWrapper name="search" size={16}/> Buscar Imagem</>}</button><label className="bg-gray-200 text-gray-700 px-4 py-2 rounded cursor-pointer text-sm hover:bg-gray-300 transition-colors w-full text-center" title="Carregar foto"><input type="file" className="hidden" accept="image/*" onChange={handleFileUpload} /><IconWrapper name="image" size={16}/> Carregar do Dispositivo</label></div>
                                        <div className="grid grid-cols-4 gap-2 max-h-32 overflow-y-auto">{bgList.map(bg => (<div key={bg.id} onClick={()=>setSelectedBg(bg)} className={`h-12 bg-gray-200 cursor-pointer rounded border-2 ${selectedBg.id === bg.id ? 'border-yellow-500' : 'border-transparent'}`} style={{background: bg.type==='gradient'?bg.gradient:`url(${bg.url}) center/cover`}}></div>))}</div>
                                        <div className="flex gap-2"><button onClick={downloadCard} className="flex-1 bg-red-700 text-white font-bold py-3 rounded hover:bg-red-800 flex justify-center gap-2"><IconWrapper name="download"/> Baixar</button><button onClick={shareCard} className="bg-yellow-500 text-white font-bold py-3 px-4 rounded hover:bg-yellow-600" title="Partilhar"><IconWrapper name="share-2"/></button></div>
                                        <p className="text-xs text-gray-500 text-center">Para Instagram: Baixe a imagem e poste manualmente.</p>
                                    </div>
                                    <div className="flex justify-center items-center bg-gray-100 rounded border overflow-hidden relative"><canvas ref={canvasRef} className="max-w-full h-auto shadow-lg cursor-move" style={{maxHeight:'300px', touchAction: 'none'}} onMouseDown={handleMouseDown} onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp} onTouchStart={handleMouseDown} onTouchMove={handleTouchMove} onTouchEnd={handleMouseUp}></canvas><div className="absolute bottom-2 right-2 text-[10px] text-gray-400 pointer-events-none">Arraste o texto</div></div>
                                </div>
                            </div>
                        )}
                        {/* --- NOMES --- */}
                        {activeTab === 'names' && (
                            <div className="max-w-2xl mx-auto space-y-8 animate-fadeIn">
                                <BackButton /><div className="bg-white p-8 rounded-xl shadow-lg text-center"><h2 className="text-2xl font-bold mb-4 text-red-800">Significado dos Nomes</h2><div className="flex gap-2"><input type="text" value={inputName} onChange={(e)=>setInputName(e.target.value)} className="flex-1 p-3 border rounded text-gray-800" placeholder="Digite o nome..." /><button onClick={analyzeNames} className="bg-red-700 text-white px-6 py-3 rounded font-bold hover:bg-red-800">Ver</button></div></div>
                                {nameResult && <div className="space-y-4">{nameResult.map((item, i) => (<div key={i} className="bg-white p-6 rounded shadow border-l-4 border-yellow-500"><h3 className="font-bold text-gray-800">{item.name}</h3><p className="text-gray-600">{item.meaning}</p></div>))}</div>}
                            </div>
                        )}
                        {/* --- FINANCEIRO (SUBSTITUÍDO PELO FINANCIAL APP) --- */}
                        {activeTab === 'finance' && (
                            <FinancialModule onBack={() => setActiveTab('home')} />
                        )}
                        {/* --- PREGAÇÃO --- */}
                        {activeTab === 'preaching' && (
                            <div className="max-w-2xl mx-auto bg-white rounded-xl shadow p-8 animate-fadeIn text-center">
                                <BackButton /><h2 className="text-2xl font-bold mb-6 flex justify-center gap-2 text-red-800"><IconWrapper name="megaphone" className="text-yellow-500"/> Pregação</h2>
                                <button onClick={()=>{setSermon(preachingDatabase[Math.floor(Math.random()*preachingDatabase.length)])}} className="bg-red-700 text-white px-6 py-3 rounded-full font-bold shadow hover:bg-red-800 mb-6 flex items-center justify-center gap-2 mx-auto"><IconWrapper name="refresh-cw"/> Gerar Esboço</button>
                                {sermon && (<div className="text-left bg-gray-50 p-6 rounded border border-gray-200"><h3 className="text-xl font-bold mb-2 text-red-800">{sermon.ref}</h3><p className="italic text-gray-600 mb-4">"{sermon.text}"</p><p className="whitespace-pre-line text-gray-700">{sermon.explanation}</p></div>)}
                            </div>
                        )}
                        {/* --- JOGOS (QUIZ + MEMORY + FORCA) --- */}
                        {activeTab === 'games' && (
                            <div className="max-w-4xl mx-auto bg-white rounded-xl shadow p-8 animate-fadeIn text-center relative overflow-hidden min-h-[500px]">
                                <BackButton />
                                {gameMode === 'menu' && (
                                    <div className="animate-fadeIn">
                                        <h2 className="text-2xl font-bold mb-8 text-red-800 flex justify-center items-center gap-2"><IconWrapper name="gamepad-2" className="text-yellow-500"/> Área de Jogos</h2>
                                        <div className="grid md:grid-cols-2 gap-6">
                                            <div onClick={startQuiz} className="bg-yellow-50 border-2 border-yellow-200 p-8 rounded-xl cursor-pointer hover:shadow-lg hover:scale-105 transition-transform"><div className="text-4xl mb-4">📖</div><h3 className="text-xl font-bold text-gray-800 mb-2">Quiz Bíblico</h3><p className="text-gray-600 text-sm">Desafio de 10 minutos. Teste seus conhecimentos!</p></div>
                                            <div onClick={startMemoryGame} className="bg-blue-50 border-2 border-blue-200 p-8 rounded-xl cursor-pointer hover:shadow-lg hover:scale-105 transition-transform"><div className="text-4xl mb-4">🐶</div><h3 className="text-xl font-bold text-gray-800 mb-2">Jogo da Memória</h3><p className="text-gray-600 text-sm">Encontre os pares dos animais. Com sons!</p></div>
                                            <div onClick={startHangmanGame} className="bg-green-50 border-2 border-green-200 p-8 rounded-xl cursor-pointer hover:shadow-lg hover:scale-105 transition-transform md:col-span-2"><div className="text-4xl mb-4">⚓</div><h3 className="text-xl font-bold text-gray-800 mb-2">Jogo da Forca</h3><p className="text-gray-600 text-sm">Adivinhe a palavra antes que o tempo acabe!</p></div>
                                        </div>
                                    </div>
                                )}
                                {gameMode === 'quiz' && (
                                    <div className="animate-fadeIn">
                                        <div className="flex justify-between items-center mb-6"><button onClick={() => setGameMode('menu')} className="text-sm font-bold text-gray-500 hover:text-gray-700">← Voltar</button><h2 className="text-xl font-bold text-red-800">Quiz Bíblico</h2><div className="w-20"></div></div>
                                        {!quizActive && !showQuizScore && !quizGameOver && (<div className="space-y-6"><p className="text-gray-600 mb-4">Responda a 10 perguntas sorteadas aleatoriamente. Cada acerto vale 10 pontos!</p><button onClick={startQuiz} className="bg-red-700 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-red-800">INICIAR AGORA</button></div>)}
                                        {quizActive && !showQuizScore && !quizGameOver && currentQuizQuestions.length > 0 && (<div><div className="flex justify-between items-center mb-6 bg-gray-100 p-3 rounded-lg"><div className="text-red-800 font-bold flex items-center gap-2"><div className="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>{formatTime(quizTimer)}</div><div className="text-gray-600 font-bold text-sm">Questão {quizIndex + 1}/10</div><div className="text-yellow-600 font-bold">{quizScore} pts</div></div><h3 className="text-xl font-bold mb-8 text-gray-800 min-h-[60px] flex items-center justify-center">{currentQuizQuestions[quizIndex].question}</h3><div className="grid gap-3">{currentQuizQuestions[quizIndex].options.map((opt, i) => (<button key={i} onClick={() => handleQuizAnswer(i)} className="p-4 border-2 border-gray-200 rounded-xl hover:bg-yellow-50 hover:border-yellow-500 font-medium text-gray-700 transition-all text-left relative group"><span className="absolute left-4 font-bold text-gray-300 group-hover:text-yellow-600">{['A','B','C','D'][i]}</span><span className="pl-8">{opt}</span></button>))}</div></div>)}
                                        {showQuizScore && (<div className="py-8"><div className="mb-6">{quizScore >= 70 ? <IconWrapper name="check-circle" size={64} className="text-green-500 mx-auto mb-4"/> : <IconWrapper name="activity" size={64} className="text-yellow-500 mx-auto mb-4"/>}<h3 className="text-3xl font-bold text-gray-800 mb-2">{quizScore >= 70 ? "Parabéns!" : "Bom esforço!"}</h3></div><div className="text-5xl font-arcade text-red-800 mb-8">{quizScore} <span className="text-lg font-sans text-gray-500">pontos</span></div><button onClick={startQuiz} className="bg-yellow-500 text-white px-8 py-3 rounded-full font-bold hover:bg-yellow-600 shadow-lg flex items-center gap-2 mx-auto"><IconWrapper name="refresh-cw" size={20}/> Jogar Novamente</button></div>)}
                                        {quizGameOver && (<div className="py-8"><div className="mb-6 text-red-600"><IconWrapper name="x" size={64} className="mx-auto mb-4"/><h3 className="text-3xl font-bold mb-2">Tempo Esgotado!</h3></div><button onClick={startQuiz} className="bg-red-700 text-white px-8 py-3 rounded-full font-bold hover:bg-red-800 shadow-lg flex items-center gap-2 mx-auto"><IconWrapper name="refresh-cw" size={20}/> Tentar Novamente</button></div>)}
                                    </div>
                                )}
                                {gameMode === 'memory' && (
                                    <div className="animate-fadeIn font-inter">
                                        <div className="flex justify-between items-center mb-6"><button onClick={() => setGameMode('menu')} className="text-sm font-bold text-gray-500 hover:text-gray-700">← Voltar</button><h2 className="text-xl font-bold text-blue-600">Jogo da Memória</h2><div className="text-sm font-bold text-gray-600">Jogadas: {memoryMoves}</div></div>
                                        {!memoryWin ? (<div className="grid grid-cols-4 gap-4 justify-center max-w-sm mx-auto">{memoryCards.map((card) => (<div key={card.id} className={`memory-card h-20 w-full ${card.isFlipped || card.isMatched ? 'is-flipped' : ''}`} onClick={() => handleMemoryCardClick(card)}><div className="memory-card-inner"><div className="memory-card-back flex items-center justify-center text-2xl font-bold">?</div><div className="memory-card-front flex items-center justify-center text-4xl">{card.emoji}</div></div></div>))}</div>) : (<div className="py-12"><h3 className="text-3xl font-bold text-blue-600 mb-4">Você Venceu!</h3><button onClick={startMemoryGame} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors text-lg">Reiniciar Jogo</button></div>)}
                                    </div>
                                )}
                                {gameMode === 'hangman' && (
                                    <div className="animate-fadeIn font-inter w-full max-w-4xl mx-auto">
                                         <div className="flex justify-between items-center mb-6"><button onClick={() => setGameMode('menu')} className="text-sm font-bold text-gray-500 hover:text-gray-700">← Voltar</button><h2 className="text-xl font-bold text-blue-600">Jogo da Forca</h2><div className={`text-xl font-bold ${hangmanTimer <= 10 ? 'text-red-600 animate-pulse' : 'text-blue-600'}`}>{formatTime(hangmanTimer)}</div></div>
                                        {hangmanStatus === 'playing' ? (<div className="flex flex-col md:flex-row gap-8"><div className="flex-1 flex flex-col items-center"><svg className="w-64 h-64 mb-4" viewBox="0 0 100 120"><line x1="10" y1="115" x2="90" y2="115" stroke="#6B7280" strokeWidth="4" /><line x1="30" y1="115" x2="30" y2="10" stroke="#6B7280" strokeWidth="4" /><line x1="30" y1="10" x2="70" y2="10" stroke="#6B7280" strokeWidth="4" /><line x1="70" y1="10" x2="70" y2="25" stroke="#6B7280" strokeWidth="4" /><circle cx="70" cy="35" r="10" className="hangman-part" style={{opacity: hangmanWrong.length >= 1 ? 1 : 0}} fill="none" /><line x1="70" y1="45" x2="70" y2="75" className="hangman-part" style={{opacity: hangmanWrong.length >= 2 ? 1 : 0}} /><line x1="70" y1="55" x2="55" y2="45" className="hangman-part" style={{opacity: hangmanWrong.length >= 3 ? 1 : 0}} /><line x1="70" y1="55" x2="85" y2="45" className="hangman-part" style={{opacity: hangmanWrong.length >= 4 ? 1 : 0}} /><line x1="70" y1="75" x2="55" y2="95" className="hangman-part" style={{opacity: hangmanWrong.length >= 5 ? 1 : 0}} /><line x1="70" y1="75" x2="85" y2="95" className="hangman-part" style={{opacity: hangmanWrong.length >= 6 ? 1 : 0}} /></svg><div className="text-red-500 font-bold text-xl mb-4">Erros: {hangmanWrong.length} / 6</div><div className="flex flex-wrap justify-center gap-2 mb-4">{hangmanWord.split('').map((char, idx) => (<div key={idx} className={`w-8 h-10 md:w-10 md:h-12 border-b-4 flex items-center justify-center text-2xl font-bold ${hangmanGuessed.includes(char) ? 'border-blue-500 text-blue-600' : 'border-gray-300 text-transparent'}`}>{char}</div>))}</div></div><div className="flex-1">{hangmanWrong.length >= 3 && (<div className="mb-4 bg-green-100 text-green-700 p-3 rounded-lg font-bold animate-fadeIn">Dica: A categoria é {hangmanCategory}</div>)}<div className="flex flex-wrap justify-center gap-2">{'ABCDEFGHIJKLMNOPQRSTUVWXYZÇ'.split('').map(letter => (<button key={letter} onClick={() => handleHangmanGuess(letter)} disabled={hangmanGuessed.includes(letter) || hangmanWrong.includes(letter)} className={`w-10 h-10 md:w-12 md:h-12 font-bold rounded-lg text-lg transition-all shadow-md ${hangmanGuessed.includes(letter) || hangmanWrong.includes(letter) ? 'bg-gray-300 text-gray-500 cursor-not-allowed opacity-50' : 'bg-blue-100 hover:bg-blue-200 text-blue-800 active:scale-95'}`}>{letter}</button>))}</div></div></div>) : (<div className="py-12 animate-fadeIn bg-white rounded-xl"><h3 className={`text-4xl font-bold mb-4 ${hangmanStatus === 'won' ? 'text-green-600' : 'text-red-600'}`}>{hangmanStatus === 'won' ? 'Você Venceu!' : 'Fim de Jogo!'}</h3><p className="text-gray-600 mb-2">A palavra era:</p><p className="text-4xl font-bold text-blue-600 mb-8 tracking-widest">{hangmanWord}</p><button onClick={startHangmanGame} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-colors text-lg flex items-center gap-2 mx-auto"><IconWrapper name="refresh-cw" size={24}/> Jogar Novamente</button></div>)}
                                    </div>
                                )}
                            </div>
                        )}
                        {/* --- QR CODE --- */}
                        {activeTab === 'qrcode' && (
                            <div className="max-w-4xl mx-auto space-y-8 animate-fadeIn">
                                <BackButton /><h2 className="text-2xl font-bold text-center mb-6 flex justify-center gap-2 text-red-800"><IconWrapper name="search" className="text-yellow-500"/> Gerador de QR Code</h2>
                                <div className="grid md:grid-cols-2 gap-6">
                                    <div className="bg-white p-6 rounded-xl shadow"><h3 className="font-bold mb-4 text-gray-700">Site / Link</h3><input type="text" value={qrUrl} onChange={(e)=>setQrUrl(e.target.value)} placeholder="https://..." className="w-full p-2 border rounded mb-2 text-gray-800" /><button onClick={handleGerarUrl} className="w-full bg-red-700 text-white p-2 rounded hover:bg-red-800">Gerar</button></div>
                                    <div className="bg-white p-6 rounded-xl shadow"><h3 className="font-bold mb-4 text-gray-700">Wi-Fi</h3><input type="text" value={qrWifiSsid} onChange={(e)=>setQrWifiSsid(e.target.value)} placeholder="Nome da Rede" className="w-full p-2 border rounded mb-2 text-gray-800" /><input type="text" value={qrWifiPass} onChange={(e)=>setQrWifiPass(e.target.value)} placeholder="Senha" className="w-full p-2 border rounded mb-2 text-gray-800" /><button onClick={handleGerarWifi} className="w-full bg-red-700 text-white p-2 rounded hover:bg-red-800">Gerar</button></div>
                                    <div className="bg-white p-6 rounded-xl shadow md:col-span-2"><h3 className="font-bold mb-4 text-gray-700">PIX</h3><div className="grid md:grid-cols-2 gap-2"><input type="text" value={qrPixKey} onChange={(e)=>setQrPixKey(e.target.value)} placeholder="Chave Pix" className="w-full p-2 border rounded text-gray-800" /><input type="text" value={qrPixName} onChange={(e)=>setQrPixName(e.target.value)} placeholder="Nome Completo" className="w-full p-2 border rounded text-gray-800" /><input type="text" value={qrPixCity} onChange={(e)=>setQrPixCity(e.target.value)} placeholder="Cidade" className="w-full p-2 border rounded text-gray-800" /><input type="text" value={qrPixAmount} onChange={(e)=>setQrPixAmount(e.target.value)} placeholder="Valor (ex: 10,00)" className="w-full p-2 border rounded text-gray-800" /></div><button onClick={handleGerarPix} className="w-full bg-red-700 text-white p-2 rounded mt-2 hover:bg-red-800">Gerar PIX</button></div>
                                </div>
                                <div className="bg-white p-8 rounded-xl shadow flex flex-col items-center"><div id="qrcode-container" ref={qrCodeRef} className="mb-4"></div><div className="flex gap-2"><button onClick={downloadQRCode} className="bg-gray-200 px-4 py-2 rounded flex items-center gap-2 text-gray-700 hover:bg-gray-300"><IconWrapper name="download" size={16}/> Baixar</button><button onClick={()=>window.print()} className="bg-gray-200 px-4 py-2 rounded flex items-center gap-2 text-gray-700 hover:bg-gray-300"><IconWrapper name="printer" size={16}/> Imprimir</button></div></div>
                            </div>
                        )}
                        {/* --- RÁDIO --- */}
                        {activeTab === 'radio' && (
                            <div className="max-w-4xl mx-auto animate-fadeIn">
                                <BackButton /><h2 className="text-2xl font-bold text-center mb-6 flex justify-center gap-2 text-red-800"><IconWrapper name="radio" className="text-yellow-500"/> Rádio Gospel</h2>
                                <div className="bg-gradient-to-r from-gray-900 to-gray-800 text-white rounded-xl shadow-xl overflow-hidden mb-8 border border-gray-700">
                                    <div className="p-6 md:p-8 flex flex-col items-center justify-center text-center">
                                        <div className="bg-red-600 text-xs font-bold px-3 py-1 rounded-full mb-4 animate-pulse">AO VIVO</div>
                                        <h3 className="text-2xl md:text-3xl font-bold mb-2">Rádio Gospel 24h</h3>
                                        <p className="text-gray-400 text-sm mb-8">Louvor e Adoração sem parar</p>
                                        <div className="h-12 flex items-center justify-center gap-1 mb-8">{isPlayingRadio ? (<><div className="sound-bar h-8"></div><div className="sound-bar h-12"></div><div className="sound-bar h-6"></div><div className="sound-bar h-10"></div><div className="sound-bar h-4"></div></>) : (<div className="h-1 w-32 bg-gray-700 rounded-full"></div>)}</div>
                                        <button onClick={toggleRadio} className={`w-20 h-20 rounded-full flex items-center justify-center transition-all transform hover:scale-110 shadow-lg ${isPlayingRadio ? 'bg-yellow-500 text-gray-900' : 'bg-red-600 text-white'}`}>{isPlayingRadio ? <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" /></svg> : <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3" /></svg>}</button>
                                        <div className="mt-8 pt-6 border-t border-gray-700 w-full"><p className="text-xs text-gray-400 mb-2">Procurando a Rádio Gospel Campinas?</p><a href="http://www.radiogospelcampinas.com.br/" target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 text-yellow-500 hover:text-yellow-400 font-bold text-sm underline"><IconWrapper name="external-link" size={14}/> Ir para o Site Oficial (Link HTTP)</a></div>
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* --- DIÁRIO --- */}
                        {activeTab === 'notes' && (
                            <div className="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow animate-fadeIn">
                                <BackButton />
                                <h2 className="text-2xl font-bold mb-4 flex items-center gap-2 text-red-800">
                                    <IconWrapper name="calendar" className="text-yellow-500"/> Diário de Oração
                                </h2>
                                
                                <div className="flex items-center justify-between mb-4 bg-gray-50 p-3 rounded-lg border">
                                    <button onClick={() => changeDay(-1)} className="p-2 hover:bg-gray-200 rounded-full transition-colors text-gray-600">
                                        <IconWrapper name="chevron-left" />
                                    </button>
                                    
                                    <div className="text-center">
                                        <h3 className="font-bold text-lg text-gray-800 capitalize">{formatDateDisplay(currentDate)}</h3>
                                        {formatDateKey(currentDate) !== formatDateKey(new Date()) && (
                                            <button onClick={goToToday} className="text-xs text-red-600 font-bold hover:underline">
                                                Voltar para Hoje
                                            </button>
                                        )}
                                    </div>
                                    
                                    <button onClick={() => changeDay(1)} className="p-2 hover:bg-gray-200 rounded-full transition-colors text-gray-600">
                                        <IconWrapper name="chevron-right" />
                                    </button>
                                </div>

                                <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                                    <p className="text-sm text-yellow-800">Escreva aqui as suas orações para este dia. Tudo é salvo automaticamente.</p>
                                </div>
                                
                                <textarea 
                                    value={getCurrentEntry()} 
                                    onChange={handleDiaryChange} 
                                    className="w-full h-80 p-6 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none resize-none font-handwriting text-lg bg-gray-50 text-gray-800 leading-relaxed" 
                                    placeholder={`Querido Deus, neste dia ${currentDate.getDate()} eu quero...`}
                                ></textarea>
                                
                                <div className="mt-4 flex justify-between items-center">
                                    <span className="text-xs text-gray-400">Salvo automaticamente no navegador</span>
                                    <button onClick={saveNote} className="bg-red-700 text-white px-6 py-2 rounded font-bold hover:bg-red-800 flex items-center gap-2">
                                        <IconWrapper name="edit-3" size={16}/> Salvar Manualmente
                                    </button>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* BOTÃO FLUTUANTE WHATSAPP (NOVO) */}
                    <a 
                        href="https://wa.me/5575998312170" 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="fixed bottom-6 right-6 bg-green-500 text-white p-4 rounded-full shadow-2xl hover:bg-green-600 transition-all hover:scale-110 z-50 flex items-center justify-center animate-fadeIn"
                        title="Fale conosco no WhatsApp"
                    >
                        <IconWrapper name="whatsapp" size={32} />
                    </a>

                    {/* --- RODAPÉ / FOOTER --- */}
                    <footer className="bg-gray-900 text-gray-300 py-8 mt-auto no-print border-t border-gray-800">
                        <div className="container mx-auto px-4 text-center">
                            <p className="font-bold text-lg text-white mb-2">Direitos Autorais &copy; Jânio Carlos P J</p>
                            <p className="text-sm mb-4 text-gray-400">Sugestão e atualização: 28/11/2025</p>
                        </div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><EvangelicalSystem /></ErrorBoundary>);
    </script>
</body>
</html>
